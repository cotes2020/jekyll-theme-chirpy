---
layout: post
title: "RxSwift 5.0 å†…å®¹æ›´æ–°"
date: 2019-06-12 23:12:00.000000000 +09:00
categories: [Swift]
tags: [Swift, RxSwift]
---

å‡ å¤©å‰ [RxSwift 5.0](<https://github.com/ReactiveX/RxSwift>)ç»ˆäºå‘å¸ƒäº†ï¼Œè¿™ä¸ªç‰ˆæœ¬åœ¨æºç å±‚é¢æ²¡æœ‰å¤ªå¤§çš„å˜åŠ¨ï¼Œæ›´å¤šçš„æ˜¯èˆå¼ƒäº†ä¸€äº›ä¸œè¥¿ï¼ŒåŒæ—¶é‡å‘½åäº†ä¸€äº›ä¸œè¥¿ï¼Œå¦å¤–ä¹Ÿæœ‰ä¸€äº›åº•å±‚çš„æ”¹è¿›ï¼Œè®©æˆ‘ä»¬æ¥ä¸€èµ·çœ‹çœ‹ã€‚

## Relayæ‹†åˆ†æˆç‹¬ç«‹æ¡†æ¶RxRelay

Relay æ˜¯ Subject ä¸Šçš„ä¸€ä¸ªå¾ˆå¥½çš„æŠ½è±¡å±‚ï¼Œå¯ä»¥è®©æ‚¨åœ¨ä¸å…³å¿ƒ errors æˆ– completion events çš„æƒ…å†µä¸‹ä¸­ç»§å…ƒç´ ã€‚ä»å®ƒä»¬è¢«æ·»åŠ åˆ° RxSwift åï¼Œä¸€ç›´æ˜¯ä½œä¸º RxCocoa å·¥ç¨‹çš„ä¸€éƒ¨åˆ†è€Œå­˜åœ¨çš„ã€‚

ä¸€äº›å¼€å‘äººå‘˜å¯¹æ­¤å¹¶ä¸æ»¡æ„ï¼Œå› ä¸ºè¿™æ„å‘³ç€å¿…é¡»å¯¼å…¥ RxCocoa æ‰èƒ½ä½¿ç”¨ Relayã€‚ å¦å¤–ç”±äº Linux ä¸‹æ²¡æœ‰ RxCocoaï¼Œæ‰€ä»¥åœ¨ Linux ç¯å¢ƒä¸‹ä¹Ÿæ— æ³•ä½¿ç”¨ Relayã€‚

ç”±äºä¸Šè¿°åŸå› ï¼Œåœ¨ Swift 5 ä¸­å°† Relays ç‹¬ç«‹æˆ RxRelay [2]ï¼Œå¹¶è°ƒæ•´äº† RxSwift çš„ä¾èµ–å›¾ï¼Œå¦‚ä¸‹ï¼š

![](/assets/images/rxswift-01.png)

![](/assets/images/rxswift-02.png)

è¿™è®©æ‚¨å¯ä»¥åªä½¿ç”¨ RxSwift å’Œ RxRelayï¼Œè€Œä¸ä¾èµ–äº RxCocoaï¼ˆå¦‚æœæ‚¨ä¸éœ€è¦å®ƒï¼‰ï¼Œå¹¶ä¸”è¿˜ä¸ RxJava ä¿æŒä¸€è‡´ï¼Œåœ¨ RxJava ä¸­ï¼ŒRelay æ˜¯ä¸€ä¸ªå•ç‹¬çš„æ¡†æ¶ã€‚

> æ³¨æ„ï¼šè¿™æ˜¯å‘åå…¼å®¹çš„æ›´æ”¹ï¼Œå› ä¸º RxCocoa ç›´æ¥å¯¼å…¥äº† RxRelayã€‚æ„æ€æ˜¯ï¼Œæ‚¨å¯ä»¥ç»§ç»­å¯¼å…¥ RxCocoa è€Œæ— éœ€å¯¼å…¥ RxRelayï¼Œä¸€åˆ‡éƒ½ä¼šåƒä»¥å‰ä¸€æ ·å·¥ä½œã€‚

## å¼ƒç”¨ TimeIntervalï¼Œæ”¹ç”¨ DispatchTimeInterval

RxSwift 5 å¯¹ Schedulers è¿›è¡Œäº†é‡æ„ï¼Œå¼ƒç”¨äº† TimeIntervalï¼Œè½¬è€Œä½¿ç”¨ DispatchTimeIntervalã€‚å½“éœ€è¦äºšç§’çº§æ—¶åºæ—¶ï¼ŒDispatchTimeInterval å¯ä»¥è·å¾—æ›´å¥½çš„äº‹ä»¶è°ƒåº¦ç²’åº¦å’Œæ›´é«˜çš„ç¨³å®šæ€§ã€‚

è¿™ä¼šå½±å“æ‰€æœ‰åŸºäºæ—¶é—´çš„æ“ä½œç¬¦ï¼Œä¾‹å¦‚ throttleã€timeoutã€delayã€take ç­‰ã€‚ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„å‰¯ä½œç”¨æ˜¯ï¼Œè¿™æ¶ˆé™¤äº† take çš„æ­§ä¹‰ã€‚

**RxSwift 4.x:**

```swift
observable.delay(3, scheduler: MainScheduler.instance)
observable.throttle(0.5, scheduler: MainScheduler.instance)
observable.window(timeSpan: 2.5, count: 3, scheduler: MainScheduler.instance)
observable.take(1, scheduler: MainScheduler.instance)
```

**RxSwift 5.x:**

```swift
observable.delay(.second(3), scheduler: MainScheduler.instance)
observable.throttle(.milliseconds(500), scheduler: MainScheduler.instance)
observable.window(timeSpan: .milliseconds(2500), count: 3, scheduler: MainScheduler.instance)
observable.take(.second(1), scheduler: MainScheduler.instance)
```

## Variable æœ€ç»ˆè¢«å¼ƒç”¨

Variable æ˜¯æ—©æœŸæ·»åŠ åˆ° RxSwift ä¸­çš„ä¸€ä¸ªæ¦‚å¿µï¼Œå®ƒå…è®¸æ‚¨é€šè¿‡â€œè®¾ç½®â€å’Œâ€œè·å–â€å½“å‰å€¼æ¥åˆ›å»ºä¸€ä¸ªå‘½ä»¤å¼çš„ bridgeã€‚è¿™æ˜¯ä¸€ä¸ªçœ‹ä¼¼æœ‰ç”¨çš„æªæ–½ï¼Œå¯ä»¥è®©å¼€å‘äººå‘˜æ›´å®¹æ˜“ä¸Šæ‰‹ä½¿ç”¨ RxSwiftï¼Œç›´åˆ°ä»–ä»¬å®Œå…¨é€‚åº”â€œå“åº”æ€§æ€ç»´â€ã€‚

ä¸è¿‡è¿™ç§ç»“æ„è¢«è¯æ˜æ˜¯æœ‰é—®é¢˜çš„ï¼Œå› ä¸ºå¼€å‘äººå‘˜ä¸¥é‡æ»¥ç”¨è¿™ç§ç»“æ„æ¥åˆ›å»ºé«˜åº¦å‘½ä»¤å¼çš„ç³»ç»Ÿï¼Œè€Œä¸æ˜¯ä½¿ç”¨ Rx çš„å£°æ˜å¼æ€§è´¨ã€‚è¿™å¯¹äºå“åº”å¼ç¼–ç¨‹çš„åˆå­¦è€…æ¥è¯´å°¤å…¶å¸¸è§ï¼Œå¹¶ä¸”åœ¨æ¦‚å¿µä¸Šé˜»æ­¢äº†è®¸å¤šäººç†è§£è¿™æ˜¯ä¸€ç§ä¸å¥½çš„åšæ³•å’Œä»£ç å‘³é“ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨ RxSwift 4.x ä¸­å·²ç»ä½¿ç”¨è¿è¡Œæ—¶è­¦å‘Šæ¥å‘ŠçŸ¥å°†å¼ƒç”¨ Variable çš„åŸå› ã€‚

åœ¨ RxSwift 5 ä¸­ï¼Œå®ƒç°åœ¨å·²è¢«æ­£å¼å®Œå…¨å¼ƒç”¨ï¼Œå¦‚æœæ‚¨éœ€è¦è¿™ç§è¡Œä¸ºï¼Œå»ºè®®çš„æ–¹æ³•æ˜¯ä½¿ç”¨ BehaviorRelayï¼ˆæˆ– BehaviorSubjectï¼‰ã€‚

**RxSwift 4.x:**

```swift
let variable = Variable("Hello RxSwift")
variable.value = "Goodbye RxSwift"
print(variable.value)
```

**RxSwift 5.x:**

```swift
let relay = BehaviorRelay(value: "Hello RxSwift")
relay.accept("Goodbye RxSwift")
print(relay.value)
```

## æ–°å¢ do(on:) é‡è½½

do æ˜¯ä¸€ä¸ªå¾ˆæ£’çš„æ“ä½œç¬¦ï¼Œå½“ä½ æƒ³è¦æ‰§è¡ŒæŸäº›å‰¯ä½œç”¨ï¼ˆå¦‚æ—¥å¿—è®°å½•ï¼‰æˆ–åªæ˜¯â€œç›‘å¬â€æµçš„ä¸­é—´è¿‡ç¨‹ã€‚

ä¸ºäº†ä¸ RxJava ä¿æŒä¸€è‡´ï¼ŒRxSwift ç°åœ¨ä¸ä»…æä¾› do(onNext:)ï¼Œè¿˜æä¾›å¦‚ do(afterNext:) è¿™æ ·çš„é‡è½½ã€‚onNext è¡¨ç¤ºå…ƒç´ å‘å‡ºçš„æ—¶åˆ»ï¼Œè€Œ afterNext è¡¨ç¤ºå‘å‡ºå¹¶å‘ä¸‹æ¸¸æ¨é€çš„æ—¶åˆ»ã€‚

**RxSwift 4.x:**

```swift
Observable.of("ğŸ", "ğŸ", "ğŸŠ", "ğŸ‹")
					.do(onNext: { print("Intercepted:", $0) },
              onError: { print("Intercepted error:", $0) },
              onCompleted: { print("Completed") }
          )
```

**RxSwift 5.x:**

```swift
Observable.of("ğŸ", "ğŸ", "ğŸŠ", "ğŸ‹")
					.do(onNext: { print("Intercepted:", $0) },
              afterNext: { print("Intercepted after:", $0) },
              onError: { print("Intercepted error:", $0) },
              afterError: { print("Intercepted after error:", $0) },
              onCompleted: { print("Completed") },
              afterCompleted: { print("After completed")}
          )
```

## bind(to:) ç°åœ¨æ”¯æŒå¤šä¸ªè§‚å¯Ÿè€…

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨å¿…é¡»å°†æµç»‘å®šåˆ°å¤šä¸ªè§‚å¯Ÿè€…ã€‚åœ¨ RxSwift 4 ä¸­ï¼Œæ‚¨é€šå¸¸åªæ˜¯å¤åˆ¶ç»‘å®šä»£ç ï¼š

**RxSwift 4.x:**

```swift
isFormEnabled
			.bind(to: txtName.rx.isEnabled)
			.disposed(by: disposeBag)
isFormEnabled
			.bind(to: txtEmail.rx.isEnabled)
			.disposed(by: disposeBag)
isFormEnabled
			.bind(to: txtPassword.rx.isEnabled)
			.disposed(by: disposeBag)
isFormEnabled
			.bind(to: btnSubmit.rx.isEnabled)
			.disposed(by: disposeBag)
```

**RxSwift 5.x:**

```swift
isFormEnabled
			.bind(to: txtName.rx.isEnabled,
           			txtEmail.rx.isEnabled,
           			txtPassword.rx.isEnabled,
           			btnSubmit.rx.isEnabled)
			.disposed(by: disposeBag)
```

è¿™ä»ç„¶è§£æåˆ°å•ä¸ª Disposableï¼Œè¿™æ„å‘³ç€å®ƒå‘åå…¼å®¹å•è§‚å¯Ÿè€…å˜ä½“ã€‚

## ä¸€ä¸ªæ–°çš„ compactMap æ“ä½œç¬¦

ä½œä¸ºå¼€å‘äººå‘˜ï¼Œæ‚¨å¯èƒ½ç»å¸¸å¤„ç† Optional å€¼çš„æµã€‚ä¸ºäº†è§£åŒ…è¿™äº›å€¼ï¼Œç¤¾åŒºå·²ç»æœ‰äº†è‡ªå·±çš„è§£å†³æ–¹æ¡ˆï¼Œä¾‹å¦‚æ¥è‡ª RxSwiftExt çš„è§£åŒ…è¿ç®—ç¬¦æˆ–æ¥è‡ª RxOptional çš„ filterNilã€‚

RxSwift 5 æ·»åŠ äº†ä¸€ä¸ªæ–°çš„ compactMap æ“ä½œç¬¦ï¼Œä»¥ä¸ Swift æ ‡å‡†åº“ä¿æŒä¸€è‡´ï¼Œå°†æ­¤åŠŸèƒ½å¼•å…¥æ ¸å¿ƒåº“ã€‚

**RxSwift 4.x:**

```swift
observable	// Observable<String?>
		.filter { $0 != nil }
		.map { $0! }	// Observable<String>
observable.unwrap()	// RxSwiftExt
observable.filterNil()	// RxOptional
```

**RxSwift 5.x:**

```swift
observable.compactMap { $0 }
```

## toArray() ç°åœ¨è¿”å› Single

toArray() æ˜¯ä¸€ä¸ªæ“ä½œç¬¦ï¼Œå®ƒåœ¨æµå®Œæˆåå°†æ•´ä¸ªæµä½œä¸ºæ•°ç»„å‘å‡ºã€‚

ä¸€ç›´ä»¥æ¥è¿™ä¸ªæ“ä½œç¬¦æ€»æ˜¯è¿”å›ä¸€ä¸ª Observableï¼Œä½†æ˜¯ç”±äº Traits çš„å¼•å…¥ - ç‰¹åˆ«æ˜¯ Singleï¼Œå°†è¿”å›ç±»å‹æ›´æ”¹ä¸º Single ä»¥æä¾›è¯¥ç±»å‹çš„å®‰å…¨æ€§å’Œä»…ä¿è¯ä»æ­¤æ“ä½œç¬¦è·å–å•ä¸ªå‘å°„å€¼æ˜¯å¾ˆæœ‰æ„ä¹‰çš„ã€‚

**RxSwift 4.x:**

```swift
observable.toArray()	// Observable<T>
```

**RxSwift 5.x:**

```
observable.toArray()	// Single<T>
```

## æ³›å‹çº¦æŸå‘½åæ•´ç†

RxSwift æ˜¯æ³›å‹çº¦æŸçš„é‡åº¦ä½¿ç”¨è€…ã€‚ä»æ—©æœŸå¼€å§‹ï¼Œåº“å°±ä½¿ç”¨å•å­—æ¯çº¦æŸæ¥æè¿°æŸäº›ç±»å‹ã€‚ ä¾‹å¦‚ï¼ŒObservableType.E è¡¨ç¤º Observable æµçš„æ³›å‹ç±»å‹ã€‚

è¿™æ ·å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œä½†ä¼šå¼•èµ·ä¸€äº›æ··æ·†ï¼Œä¾‹å¦‚ O å¯ä»¥ä»£è¡¨ä¸åŒåœºæ™¯ä¸­çš„ Observable å’Œ Observerï¼Œæˆ– S å¯ä»¥ä»£è¡¨ Subject å’Œ Sequence.

æ­¤å¤–ï¼Œè¿™äº›å•å­—æ¯çº¦æŸå¹¶æ²¡æœ‰æä¾›è‰¯å¥½çš„è‡ªæˆ‘æè¿°ï¼Œå¹¶ä½¿éä»£ç è´¡çŒ®è€…å¾ˆéš¾ç†è§£æ–‡æ¡£ã€‚

å‡ºäºè¿™äº›åŸå› ï¼Œæˆ‘ä»¬å¯¹ç§æœ‰å’Œå…¬å…±æ¥å£çš„å¤§å¤šæ•°æ³›å‹çº¦æŸè¿›è¡Œäº†å¤§ä¿®ï¼Œä½¿å…¶å…·æœ‰æ›´å¤šä¿¡æ¯ä»¥ä¾¿ç†è§£ã€‚

The most widely impacting rename is E and ElementType to simply Element.

å½±å“æœ€å¤§çš„é‡å‘½åå°† E å’Œ ElementType æ”¹ä¸º Elementã€‚

**RxSwift 4.x:**

```swift
extension Observable where E == String {
  func myFancyOperator() -> Observable<String> {
    return map { fancify($0) }
  }
}
```

**RxSwift 5.x:**

```swift
extension Observable where Element == String {
  func myFancyOperator() -> Observable<String> {
    return map { fancify($0) }
  }
}
```

æ³›å‹é‡å‘½åéå¸¸å¹¿æ³›ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå¤§è‡´å®Œæ•´çš„åˆ—è¡¨ã€‚è¿™äº›æ›´æ”¹ä¸­çš„å¤§å¤šæ•°éƒ½ä¸ RxSwift çš„å†…éƒ¨ API æœ‰å…³ï¼Œå…¶ä¸­åªæœ‰å°‘æ•°ä¼šå½±å“åˆ°å¼€å‘äººå‘˜ï¼š

- E å’Œ ElementType é‡å‘½åä¸º Elementï¼›
- TraitType é‡å‘½åä¸º Traitï¼›
- SharedSequence.S é‡å‘½åä¸º SharedSequence.SharingStrategyï¼›
- ä¾æƒ…å†µ O è¢«é‡å‘½åä¸º Observer å’Œ Sourceï¼›
- C å’Œ S åˆ†åˆ«é‡å‘½åä¸º Collection å’Œ Sequenceï¼›
- ä¾æƒ…å†µ S ä¹Ÿè¢«é‡å‘½åä¸º Subjectï¼›
- R è¢«é‡å‘½åä¸º Resultï¼›
- ReactiveCompatible.CompatibleType é‡å‘½åä¸ºReactiveCompatible.ReactiveBaseã€‚

## è¿ç§»é¡¹ç›®

è®¸å¤š RxSwift ç¤¾åŒºé¡¹ç›®å·²ç»è¿ç§»åˆ° RxSwift 5 å¹¶å‘å¸ƒäº†ç›¸åº”çš„ç‰ˆæœ¬ï¼Œå› æ­¤è¿ç§»è¿‡ç¨‹åº”è¯¥ç›¸å¯¹é¡ºåˆ©ã€‚å·²è¿ç§»çš„ä¸€äº›é¡¹ç›®åŒ…æ‹¬ï¼šRxSwiftExtï¼ŒRxDataSourcesï¼ŒRxAlamofireï¼ŒRxOptional ç­‰ã€‚