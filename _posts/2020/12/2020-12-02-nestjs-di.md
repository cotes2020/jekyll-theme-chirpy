---
title: "NestJSæºç ï¼šå®ç°ä¾èµ–æ³¨å…¥(DI)"
date: 2020-12-02
permalink: /2020-12-02-nestjs-di/
---
## ç›®æ ‡æ•ˆæœ


æŸä¸ªç±»ï¼ˆTestServiceï¼‰ä¸­ä¾èµ–çš„å…¶ä»–ç±»ï¼ˆUnitServiceï¼‰ï¼Œä¸éœ€è¦åœ¨TestServiceçš„æ„é€ å‡½æ•°ä¸­æ˜¾å¼çš„å®ä¾‹åŒ–ã€‚
åªéœ€è¦ä½¿ç”¨TSçš„è¯­æ³•ï¼Œç”¨privateã€publicã€readonlyã€protectedå£°æ˜æ„é€ å‡½æ•°çš„å…¥å‚ï¼ŒTestServiceèƒ½è‡ªåŠ¨å®ä¾‹åŒ–å…¥å‚ä¸­æ¶‰åŠçš„ç±»ã€‚


> è¢«privateã€publicã€readonlyã€protectedå£°æ˜çš„æ„é€ å‡½æ•°å‚æ•°ï¼Œä¼šè¢«TSè‡ªåŠ¨æ”¾å…¥åˆ°ç±»çš„å±æ€§ä¸Šï¼Œå’Œå•ç‹¬å£°æ˜ç­‰æ•ˆã€‚å‚è€ƒğŸ‘‡é—®é¢˜ã€‚


[bookmark](https://stackoverflow.com/questions/48571592/private-parameters-in-typescript)


```typescript
export class UnitService {
    public sayHello() {
        console.log('hello world!')
    }
}

@Injectable()
export class TestService {
    constructor(
        private readonly unitService: UnitService
    ) { }

    public test() {
        this.unitService.sayHello() // æ‰“å°hello worldï¼
    }
}
```


ğŸ‘†ä»£ç ä¸­ï¼Œåœ¨TestServiceçš„testæ–¹æ³•é‡Œé¢ï¼Œå°±èƒ½é€šè¿‡thisè®¿é—®åˆ°UnitServiceçš„å®ä¾‹unitServiceã€‚


## å®ç°åŸç†

1. ä½¿ç”¨Reflect Metadata è·å–ç±»çš„æ„é€ å‡½æ•°çš„å…¥å‚ç±»å‹ï¼ˆå‚è€ƒTSå…ƒæ•°æ®ï¼‰
2. å°†å…¥å‚é€ä¸ªå®ä¾‹åŒ–ï¼Œå¹¶ä¸”å°†å®ä¾‹åŒ–åçš„å¯¹è±¡æ”¾åœ¨ç±»ä¸­

## å®ç°ä»£ç 


```typescript
import "reflect-metadata";

// ä¸ºä»€ä¹ˆéœ€è¦ä¸€ä¸ªä»€ä¹ˆä¹Ÿä¸åšçš„è£…é¥°å™¨ï¼Ÿ
// è¢«è£…é¥°è¿‡çš„ç±»ï¼Œæ‰èƒ½è¯»åˆ°æ„é€ å‡½æ•°çš„å…ƒä¿¡æ¯ã€‚
const Injectable = () => {
    return (target: ClassConstructorType) => {}
};

// ä¾èµ–æ³¨å…¥å·¥å‚å‡½æ•°
const DiFactory = (target: ClassConstructorType) => {
    // è·å–å…¥å‚ç±»å‹
    const providers = Reflect.getMetadata('design:paramtypes', target)
    // é€ä¸ªå®ä¾‹åŒ–
    const args = providers.map((provider: ClassConstructorType) => new provider());
    // å°†å®ä¾‹åŒ–åçš„å¯¹è±¡ï¼Œä½œä¸ºå‚æ•°ï¼ŒæŒ‰ç…§é¡ºåºä¼ ç»™ç±»çš„æ„é€ å‡½æ•°
    return new target(...args)
}
```


ä½¿ç”¨DiFactoryæ¥åˆ›å»ºTestServiceï¼Œæ•ˆæœå¦‚ä¸‹ï¼š


```typescript
const testService = DiFactory(TestService) as TestService
testService.test() // è¾“å‡ºï¼šhello world!
```


## NestJSä¸­çš„Injectableå®ç°


åœ¨`@nestjs@7.0.0` ç‰ˆæœ¬ä¸­ï¼ŒInjectable() å‡½æ•°å®ç°å’Œä¸Šé¢çš„å®ç°ä¸€æ ·ï¼š


![Untitled.png](https://raw.githubusercontent.com/dongyuanxin/static/main/blog/imgs/2020-12-02-nestjs-di/27f6d73d9d49f121276ad6648217d491.png)


è¿™é‡Œè¿˜å­˜å‚¨äº†optionså…ƒä¿¡æ¯ï¼Œå»æ‰defineMetadataçš„é€»è¾‘ï¼Œå°±æ˜¯ä¸€ä¸ªè£¸çš„ç±»è£…é¥°å™¨ã€‚


## å…ƒä¿¡æ¯æ˜¯æ€ä¹ˆæ³¨å…¥çš„ï¼Ÿ


è¿™é‡Œæ¶‰åŠåˆ°å…ƒç¼–ç¨‹çš„æ¦‚å¿µã€‚


åœ¨ç¼–è¯‘æˆes5ä»£ç çš„æ—¶å€™ï¼Œè¦å…ˆå¤„ç†æˆè¯­æ³•æ ‘ã€‚è€Œå¤„ç†æˆè¯­æ³•æ ‘çš„è¿‡ç¨‹ä¸­ï¼Œå°±èƒ½æ‹¿åˆ°å‚æ•°çš„å…·ä½“ç±»å‹ã€‚ç„¶åå°†å…¶ä¿å­˜ä¸‹æ¥ï¼Œæä¾›æ¥å£æ”¯æŒç”¨æˆ·è¯»å–å³å¯ã€‚


å‚è€ƒé“¾æ¥ä¸­çš„çŸ¥ä¹æ–‡ç« ä¸­ï¼Œæœ‰ç¿»è¯‘åçš„es5ä»£ç ã€‚å…¶ä¸­ï¼ŒDemoServiceå’Œä¸Šé¢çš„TestServiceä¸€æ ·ï¼ŒInjectServiceå’Œä¸Šé¢çš„UnitServiceä¸€æ ·ï¼ˆè¢«æ³¨å…¥å¯¹è±¡ï¼‰ã€‚å¯ä»¥çœ‹åˆ°ï¼Œç¿»è¯‘åçš„es5ä»£ç ï¼Œå·²ç»æœ‰äº†å‚æ•°çš„ç±»å‹ä¿¡æ¯ã€‚ï¼ˆ2019å¹´ï¼‰


```typescript
// æ­¤å¤„çœç•¥äº†__decorateå’Œ__metadataçš„å®ç°ä»£ç 
var DemoService = /** @class */ (function() {
  function DemoService(injectService) {
    this.injectService = injectService;
  }
  DemoService.prototype.test = function() {
    console.log(this.injectService.a);
  };
  DemoService = __decorate(
    [Injectable(), __metadata('design:paramtypes', [InjectService])],
    DemoService
  );
  return DemoService;
})();
```


åœ¨tsæ–°ç‰ˆæœ¬ä¸­ï¼ˆ2021å¹´ï¼‰ï¼Œç”±äºè£…é¥°å™¨ææ¡ˆä¸€ç›´åœ¨æ¨è¿›ï¼Œç¿»è¯‘åçš„es5ä»£ç å·²ç»çœ‹ä¸åˆ°æ˜¾å¼çš„å‚æ•°ç±»å‹äº†ã€‚


```typescript
var TestService = /** @class */ (function () {
    function TestService(unitService) {
        this.unitService = unitService;
    }
    TestService.prototype.test = function () {
        this.unitService.sayHello();
    };
    TestService = __decorate([
        Injectable
    ], TestService);
    return TestService;
}());
```


## å‚è€ƒé“¾æ¥


[bookmark](https://zhuanlan.zhihu.com/p/72323250)


