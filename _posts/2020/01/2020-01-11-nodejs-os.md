---
title: "æ“ä½œç³»ç»Ÿæ€§èƒ½ç›‘æ§ - By NodeJS"
date: 2020-01-11
permalink: /2020-01-11-nodejs-os/
---
è¯»äº† `os` æ¨¡å—çš„æ–‡æ¡£ï¼Œç ”ç©¶äº†å‡ ä¸ªæœ‰æ„æ€çš„é—®é¢˜ï¼š

- ğŸ¤” ç†è§£å’Œè®¡ç®—â€œå¹³å‡è´Ÿè½½â€
- ğŸ¤” ç†è§£å’Œè®¡ç®—â€œcpu ä½¿ç”¨ç‡â€
- ğŸ¤” ç†è§£å’Œè®¡ç®—â€œå†…å­˜ä½¿ç”¨ç‡â€
- ğŸ¤” è¯†åˆ«æ“ä½œç³»ç»Ÿå¹³å°

## å¸¸ç”¨æŒ‡æ ‡

- æ“ä½œç³»ç»Ÿï¼šæä¾›äº†`os.platform()`å’Œ`os.type()`ï¼Œå¯ä»¥ç”¨æ¥è¯†åˆ«æ“ä½œç³»ç»Ÿå¹³å°ã€‚æ¨èä½¿ç”¨: `os.platform()`
- è¿è¡Œæ—¶é—´ï¼š
	- nodejs è¿è¡Œæ—¶é—´ï¼š`process.uptime()`
	- ç³»ç»Ÿè¿è¡Œæ—¶é—´ï¼š`os.uptime()`
- å¸¸ç”¨è·¯å¾„
	- ç³»ç»Ÿï¼ˆwindows/macosï¼‰ç©ºè®¾å¤‡ï¼š`os.devNull`
	- å½“å‰ç”¨æˆ·ä¸»è·¯å¾„ï¼š`os.homedir()`
	- ç³»ç»Ÿä¸´æ—¶æ–‡ä»¶ç›®å½•ï¼š`os.tmpdir()`
- è¿›ç¨‹è°ƒåº¦ä¼˜å…ˆçº§
	- æŸ¥è¯¢æŒ‡å®šè¿›ç¨‹ä¼˜å…ˆçº§ï¼š`os.getPriority([pid])`
	- ä¿®æ”¹æŒ‡å®š/å½“å‰è¿›ç¨‹ä¼˜å…ˆçº§ï¼š`os.setPriority([pid, ]priority)`

## ç†è§£å’Œè®¡ç®—â€œå¹³å‡è´Ÿè½½â€


> ä»€ä¹ˆæ˜¯å¹³å‡è´Ÿè½½ï¼Ÿ


å¹³å‡è´Ÿè½½æ˜¯æŒ‡ï¼šå•ä½æ—¶é—´å†…ï¼Œç³»ç»Ÿå¤„äºå¯è¿è¡ŒçŠ¶æ€å’Œä¸å¯ä¸­æ–­çŠ¶æ€çš„å¹³å‡è¿›ç¨‹æ•°ã€‚å®ƒå’Œ cpu ä½¿ç”¨ç‡æ²¡æœ‰ç›´æ¥å…³ç³»ã€‚


![e6c9d24egy1h215xjimjcj20c4058dg1.jpg](https://raw.githubusercontent.com/dongyuanxin/static/main/blog/imgs/2020-01-11-nodejs-os/e6c9d24egy1h215xjimjcj20c4058dg1.jpg)


ä»¥ä¸Šå›¾ä¸ºä¾‹ï¼Œå‡è®¾æ˜¯å•CPUå•å†…æ ¸ç³»ç»Ÿï¼Œé‚£ä¹ˆå½“CPUä»»åŠ¡ï¼ˆå›¾ä¸­çš„å°è½¦ï¼‰ä¸å¤šçš„æ—¶å€™ï¼Œå°±æ˜¯Load < 1ï¼Œä¾æ¬¡ç±»æ¨åˆ° Load = 1 ã€ Load > 1


![e6c9d24egy1h215yuh2qaj2091024dfs.jpg](https://raw.githubusercontent.com/dongyuanxin/static/main/blog/imgs/2020-01-11-nodejs-os/e6c9d24egy1h215yuh2qaj2091024dfs.jpg)


å¯¹äºå¤šæ ¸CPUï¼Œé‚£ä¹ˆä¸€ä¸ªCPUå°±æœ‰2æ¡è·¯ï¼Œé‚£ä¹ˆå½“Load = 2ï¼ˆå¤§äº1ï¼‰çš„æ—¶å€™ï¼Œç³»ç»Ÿä¹Ÿä¸ä¼šå¡é¡¿ã€‚


> å¦‚ä½•æŸ¥çœ‹å¹³å‡è´Ÿè½½ï¼Ÿ


åœ¨ nodejs ä¸­ï¼Œç›´æ¥è°ƒç”¨`os.loadavg()`å¯ä»¥è·å¾— 1ã€5 å’Œ 15 åˆ†é’Ÿçš„å¹³å‡è´Ÿè½½ï¼Œå®ƒå’Œ unix å‘½ä»¤`uptime`è¿”å›å€¼ä¸€æ ·ã€‚


> ä¸ºä»€ä¹ˆéœ€è¦å…³å¿ƒå¹³å‡è´Ÿè½½å‘¢ï¼Ÿ


å› ä¸ºè¿›ç¨‹åˆ†ä¸º 2 ç§ï¼Œç¬¬ä¸€ç§å°±æ˜¯â€œCPU å¯†é›†å‹â€ï¼Œå®ƒçš„ cpu ä½¿ç”¨ç‡å’Œå¹³å‡è´Ÿè½½éƒ½æ˜¯é«˜çš„ï¼›ç¬¬äºŒç§æ˜¯â€œIO å¯†é›†å‹â€ï¼Œå®ƒçš„ cpu ä½¿ç”¨ç‡ä¸ä¸€å®šé«˜ï¼Œä½†æ˜¯ç­‰å¾… IO ä¼šé€ æˆå¹³å‡è´Ÿè½½é«˜ã€‚


æ‰€ä»¥ï¼Œcpu ä½¿ç”¨ç‡å’Œå¹³å‡è´Ÿè½½å…±åŒååº”ç³»ç»Ÿæ€§èƒ½ã€‚


> å¦‚ä½•åˆ¤æ–­å¹³å‡è´Ÿè½½æ˜¯å¦è¿‡é«˜ï¼Ÿ


å¹³å‡æ´»è·ƒè¿›ç¨‹æ•°æœ€ç†æƒ³çš„çŠ¶æ€æ˜¯ `cpu æ•°é‡ = å¹³å‡è´Ÿè½½`ï¼Œå¦‚æœ `cpu æ•°é‡ < å¹³å‡è´Ÿè½½`ï¼Œé‚£ä¹ˆå¹³å‡è´Ÿè½½è¿‡é«˜ã€‚


```javascript
// åˆ¤æ–­æ˜¯å¦å¹³å‡è´Ÿè½½è¿‡é«˜
function isHighLoad() {
    const cpuNum = os.cpus().length; // è·å–å½“å‰ç”µè„‘CPUå†…æ ¸çš„æ•°é‡
    return os.loadavg().map(item => item > cpuNum);
}
```


## ç†è§£å’Œè®¡ç®—â€œcpu ä½¿ç”¨ç‡â€


å¾ˆå¤šç›‘æ§è½¯ä»¶éƒ½æä¾›é’ˆå¯¹ cpu ä½¿ç”¨ç‡çš„â€œå®æ—¶â€ç›‘æ§ï¼Œå½“ç„¶è¿™ä¸ªå®æ—¶ä¸æ˜¯çœŸçš„å®æ—¶ï¼Œæœ‰ä¸ªæ—¶é—´å·®ã€‚è¿™ä¸ªåŠŸèƒ½ï¼Œnodejs å¦‚ä½•å®ç°å‘¢ï¼Ÿ


**ç¬¬ä¸€æ­¥**ï¼šå°è£…`getCPUInfo()`ï¼Œè®¡ç®—è·å– cpu èŠ±è´¹çš„æ€»æ—¶é—´ä¸ç©ºé—²æ¨¡å¼èŠ±è´¹çš„æ—¶é—´ã€‚


```javascript
/**
 * è·å–cpuèŠ±è´¹çš„æ€»æ—¶é—´ä¸ç©ºé—²æ¨¡å¼çš„æ—¶é—´
 */
function getCPUInfo() {
    const cpus = os.cpus();
    let user = 0,
        nice = 0,
        sys = 0,
        idle = 0,
        irq = 0,
        total = 0;
    cpus.forEach(cpu => {
        const { times } = cpu;
        user += times.user;
        nice += times.nice;
        sys += times.sys;
        idle += times.idle;
        irq += times.irq;
    });
    total = user + nice + sys + idle + irq;
    return {
        total, // æ€»æ—¶é—´
        idle // ç©ºé—²æ—¶é—´
    };
}
```


**ç¬¬äºŒæ­¥**ï¼šå½“å‰æ—¶é—´ç‚¹ t1ï¼Œé€‰å®šä¸€ä¸ªæ—¶é—´å·® intervelï¼Œè®¡ç®— t1 å’Œ t1 + interval è¿™ä¸¤ä¸ªæ—¶é—´ç‚¹çš„ cpu æ—¶é—´å·®ä¸ç©ºé—²æ¨¡å¼æ—¶é—´å·®ï¼Œè¿”å› `1 - ç©ºé—²æ—¶é—´å·® / cpuæ—¶é—´å·®`ã€‚è¿”å›çš„ç»“æœå°±æ˜¯æ—¶é—´å·® intervel å†…çš„å¹³å‡ cpu ä½¿ç”¨ç‡ã€‚


åŒæ—¶ï¼Œ`ç©ºé—²æ—¶é—´å·® / cpuæ—¶é—´å·®` å°±æ˜¯ç©ºé—²ç‡ã€‚


```javascript
function getCPUUsage(interval = 1000) {
    const startInfo = getCPUInfo();
    return new Promise(resolve => {
        setTimeout(() => {
            const endInfo = getCPUInfo();
            const idleDiff = startInfo.idle - endInfo.idle;
            const totalDiff = startInfo.total - endInfo.total;
            resolve(1 - Math.abs(idleDiff / totalDiff));
        }, interval);
    });
}
```


ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š


```java
getCPUUsage().then(usage => console.log("cpuä½¿ç”¨ç‡ï¼š", usage));
```


## ç†è§£å’Œè®¡ç®—â€œå†…å­˜ä½¿ç”¨ç‡â€


cpu çš„æŒ‡æ ‡æœ‰å¹³å‡è´Ÿè½½ã€cpu ä½¿ç”¨ç‡ï¼Œå†…å­˜çš„æŒ‡æ ‡æœ‰å†…å­˜ä½¿ç”¨ç‡ã€‚


å€ŸåŠ© nodejs æ¥å£ï¼Œå®ç°éå¸¸ç®€å•ï¼š


```javascript
function getMemUsage() {
    return 1 - os.freemem() / os.totalmem();
}
```


## å‚è€ƒé“¾æ¥

- [Node.js os doc](http://nodejs.cn/api/os.html)
- [ç¬¬ä¸‰æ–¹æ‰©å±•åº“ï¼šos-utils](https://www.npmjs.com/package/os-utils)
- [ç³»ç»Ÿå¹³å‡è´Ÿè½½load averageè¯¦è§£ è½¬è½½](https://blog.51cto.com/u_15077533/4173309)
- [å­—èŠ‚åºï¼ˆå¤§å°ç«¯ï¼‰ç†è§£](https://blog.csdn.net/sunflower_della/article/details/90439935)

