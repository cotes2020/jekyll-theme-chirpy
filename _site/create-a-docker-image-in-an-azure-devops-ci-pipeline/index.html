<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Create a Docker Image in an Azure DevOps CI Pipeline | Programming With Wolfgang</title><meta name="generator" content="Jekyll v4.1.0" /><meta property="og:title" content="Create a Docker Image in an Azure DevOps CI Pipeline" /><meta name="author" content="Wolfgang Ofner" /><meta property="og:locale" content="en_US" /><meta name="description" content="In my last post, I showed how to build a .NET Core Microservice inside a Docker container. Today, I want to build this microservice in an Azure DevOps CI pipeline and push the image to Dockerhub." /><meta property="og:description" content="In my last post, I showed how to build a .NET Core Microservice inside a Docker container. Today, I want to build this microservice in an Azure DevOps CI pipeline and push the image to Dockerhub." /><link rel="canonical" href="https://thankful-island-07643b903.azurestaticapps.net//create-a-docker-image-in-an-azure-devops-ci-pipeline/" /><meta property="og:url" content="https://thankful-island-07643b903.azurestaticapps.net//create-a-docker-image-in-an-azure-devops-ci-pipeline/" /><meta property="og:site_name" content="Programming With Wolfgang" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-09-14T14:34:59+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Create a Docker Image in an Azure DevOps CI Pipeline" /><meta name="twitter:site" content="@wolfgang_ofner" /><meta name="twitter:creator" content="@Wolfgang Ofner" /><meta name="google-site-verification" content="xxsPm-h6A0B6a0QMgqXO80PU4DbMt4Dq06p-SGzB3TU" /> <script type="application/ld+json"> {"url":"https://thankful-island-07643b903.azurestaticapps.net//create-a-docker-image-in-an-azure-devops-ci-pipeline/","@type":"BlogPosting","headline":"Create a Docker Image in an Azure DevOps CI Pipeline","dateModified":"2020-09-14T14:34:59+02:00","datePublished":"2020-09-14T14:34:59+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://thankful-island-07643b903.azurestaticapps.net//create-a-docker-image-in-an-azure-devops-ci-pipeline/"},"author":{"@type":"Person","name":"Wolfgang Ofner"},"description":"In my last post, I showed how to build a .NET Core Microservice inside a Docker container. Today, I want to build this microservice in an Azure DevOps CI pipeline and push the image to Dockerhub.","@context":"https://schema.org"}</script><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/jquery@3.4.1" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"> <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" async></script> <script src="/assets/js/post.min.js" async></script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-112077092-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-112077092-1'); </script> <script src="/app.js" defer></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/author/wolfgang-small.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/">Programming With Wolfgang</a></div><div class="site-subtitle font-italic">Let's talk programming</div></div></div><div class="d-flex justify-content-center"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel">Cancel</span></div><ul class="nav flex-column mt-3"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <i class="mode-toggle fas fa-sun" dark-mode-invisible></i> <i class="mode-toggle fas fa-moon" light-mode-invisible></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.mode != null) { if (this.mode == ModeToggle.DARK_MODE) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.mode != null) { if (self.mode == ModeToggle.DARK_MODE) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightkMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightkMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/wolfgangofner" target="_blank" > <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/wolfgang_ofner" target="_blank" > <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/wolfgangofner" target="_blank" > <i class="fab fa-linkedin"></i> </a> <a href=" javascript:window.open('mailto:' + ['wolfgang','programmingwithwolfgang.com'].join('@'))" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" > <i class="fas fa-rss"></i> </a></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Create a Docker Image in an Azure DevOps CI Pipeline</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Sep 14, 2020, 2:34 PM +0200" > Sep 14 <i class="unloaded">2020-09-14T14:34:59+02:00</i> </span> by <span class="author"> Wolfgang Ofner </span></div><div> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sat, Oct 24, 2020, 2:51 PM +0200" > Oct 24 <i class="unloaded">2020-10-24T14:51:39+02:00</i> </span></div></div><div class="post-content"><p><a href="/add-docker-to-a-asp-net-core-microservice/" target="_blank" rel="noopener noreferrer">In my last post</a>, I showed how to build a .NET Core Microservice inside a Docker container. Today, I want to build this microservice in an Azure DevOps CI pipeline and push the image to Dockerhub.</p><h2 id="set-up-a-service-connection-to-docker-hub">Set up a Service Connection to Docker Hub</h2><p>Before I create the new CI Pipeline for building the Docker image, I set up a connection to Docker Hub to push my image to its repository. To do that in Azure DevOps, click on Project Settings –&gt; Service connections –&gt; New service connection.</p><div id="attachment_2371" style="width: 710px" class="wp-caption aligncenter"> <a href="/assets/img/posts/2020/09/Create-a-new-service-connection.jpg"><img aria-describedby="caption-attachment-2371" loading="lazy" class="wp-image-2371" src="/assets/img/posts/2020/09/Create-a-new-service-connection.jpg" alt="Create a new service connection" width="700" height="353" /></a><p id="caption-attachment-2371" class="wp-caption-text"> Create a new service connection</p></div><p>This opens a pop-up where you select Docker Registry.</p><div id="attachment_2372" style="width: 478px" class="wp-caption aligncenter"> <a href="/assets/img/posts/2020/09/Select-Docker-Registry-for-your-service-connection.jpg"><img aria-describedby="caption-attachment-2372" loading="lazy" class="size-full wp-image-2372" src="/assets/img/posts/2020/09/Select-Docker-Registry-for-your-service-connection.jpg" alt="Select Docker Registry for your service connection" width="468" height="287" /></a><p id="caption-attachment-2372" class="wp-caption-text"> Select Docker Registry for your service connection</p></div><p>On the next page, select Docker Hub as your Registry type, enter your Docker ID, password and set a name for your connection. Then click Verify and save.</p><div id="attachment_2373" style="width: 367px" class="wp-caption aligncenter"> <a href="/assets/img/posts/2020/09/Configure-the-service-connection.jpg"><img aria-describedby="caption-attachment-2373" loading="lazy" class="wp-image-2373" src="/assets/img/posts/2020/09/Configure-the-service-connection.jpg" alt="Configure the service connection for the DevOps CI pipeline" width="357" height="700" /></a><p id="caption-attachment-2373" class="wp-caption-text"> Configure the service connection</p></div><h2 id="create-a-new-azure-devops-ci-pipeline">Create a new Azure DevOps CI Pipeline</h2><p>After setting up the service connection, create a new CI Pipeline. Select the source code location and then any template. After the yml file is created, delete its content. For more details on creating a Pipeline, see my post “<a href="/build-net-core-in-a-ci-pipeline-in-azure-devops/" target="_blank" rel="noopener noreferrer">Build .Net Core in a CI Pipeline in Azure DevOps</a>“.</p><div id="attachment_2367" style="width: 553px" class="wp-caption aligncenter"> <a href="/assets/img/posts/2020/09/Create-an-empty-Pipeline.jpg"><img aria-describedby="caption-attachment-2367" loading="lazy" class="wp-image-2367 size-full" src="/assets/img/posts/2020/09/Create-an-empty-Pipeline.jpg" alt="Create an empty DevOps CI pipeline" width="543" height="187" /></a><p id="caption-attachment-2367" class="wp-caption-text"> Create an empty Pipeline</p></div><h3 id="configure-the-pipeline">Configure the Pipeline</h3><p>First, you have to set up some basic configuration for the pipeline. I will give it a name, set a trigger to run the pipeline every time a commit is made to master and use an Ubuntu agent. You can do this with the following code:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="na">name </span><span class="pi">:</span> <span class="s">Docker-CI</span>
<span class="na">trigger</span><span class="pi">:</span>
  <span class="na">branches</span><span class="pi">:</span>
    <span class="na">include</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">master</span>
 
<span class="na">pool</span><span class="pi">:</span>
  <span class="na">vmImage</span><span class="pi">:</span> <span class="s1">'</span><span class="s">ubuntu-latest'</span>
</pre></table></code></div></div><p>In the next section, I set up the variables for my pipeline. Since this is a very simple example, I only need one for the image name. I define a name and set the tag to the build id using the built-in variable $(Build.BuildId). This increases the tag of my image automatically every time when a build runs.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="na">variables</span><span class="pi">:</span>
  <span class="na">ImageName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">wolfgangofner/microservicedemo:$(Build.BuildId)'</span>  
</pre></table></code></div></div><p>If you want better versioning of the Docker images, use one of the many extensions from the marketplace. In my projects, we use one of our own plugins which you can find <a href="https://marketplace.visualstudio.com/items?itemName=4tecture.BuildVersioning" target="_blank" rel="noopener noreferrer">here</a>.</p><h3 id="build-the-docker-image">Build the Docker Image</h3><p>Now that everything is set up, let’s add a task to build the image. Before you can do that, you have to add a stage and a job. You can use whatever name you want for your stage and job. For now, you only need one. It is good practice to use a meaningful name though.</p><p>Inside the job, add a task for Docker. Inside this task add your previously created service connection, the location to the dockerfile, an image name, and the build context. As the command use Build an Image. Note that I use version 1 because version 2 was not working and resulted in an error I could not resolve.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="na">stages</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s">Build</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">Build image</span>
  <span class="na">jobs</span><span class="pi">:</span>  
  <span class="pi">-</span> <span class="na">job</span><span class="pi">:</span> <span class="s">DockerImage</span>
    <span class="na">displayName</span><span class="pi">:</span> <span class="s">Build and push Docker image</span>
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">Docker@1</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Build</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">Docker</span><span class="nv"> </span><span class="s">image'</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">containerregistrytype</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Container</span><span class="nv"> </span><span class="s">Registry'</span>
        <span class="na">dockerRegistryEndpoint</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Docker</span><span class="nv"> </span><span class="s">Hub'</span>
        <span class="na">command</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Build</span><span class="nv"> </span><span class="s">an</span><span class="nv"> </span><span class="s">image'</span>
        <span class="na">dockerFile</span><span class="pi">:</span> <span class="s1">'</span><span class="s">**/Dockerfile'</span>
        <span class="na">imageName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(ImageName)'</span>
        <span class="na">includeLatestTag</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">useDefaultContext</span><span class="pi">:</span> <span class="no">false</span>
        <span class="na">buildContext</span><span class="pi">:</span> <span class="s1">'</span><span class="s">.'</span>
</pre></table></code></div></div><p>You can either add the YAML code from above or click on the Docker task on the right side. You can also easily edit a task by clicking Settings right above the task. This will open the task on the right side.</p><div id="attachment_2374" style="width: 710px" class="wp-caption aligncenter"> <a href="/assets/img/posts/2020/09/Edit-the-Docker-task.jpg"><img aria-describedby="caption-attachment-2374" loading="lazy" class="wp-image-2374" src="/assets/img/posts/2020/09/Edit-the-Docker-task.jpg" alt="Edit the Docker task in the DevOps CI pipeline" width="700" height="532" /></a><p id="caption-attachment-2374" class="wp-caption-text"> Edit the Docker task</p></div><p>Save the pipeline and run it. This should give you a green build.</p><h3 id="push-the-image-to-docker-hub">Push the Image to Docker Hub</h3><p>The last step is to push the image to a registry. For this example, I use Docker Hub because it is publicly available but you can also use a private one like Azure Container Registry (ACR) or even a private Docker Hub repository.</p><p>Add the following code to your pipeline:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">Docker@1</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Push</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">Docker</span><span class="nv"> </span><span class="s">image</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">Dockerhub'</span>
  <span class="na">inputs</span><span class="pi">:</span>
    <span class="na">containerregistrytype</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Container</span><span class="nv"> </span><span class="s">Registry'</span>
    <span class="na">dockerRegistryEndpoint</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Docker</span><span class="nv"> </span><span class="s">Hub'</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Push</span><span class="nv"> </span><span class="s">an</span><span class="nv"> </span><span class="s">image'</span>
    <span class="na">imageName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(ImageName)'</span>
  <span class="na">condition</span><span class="pi">:</span> <span class="s">and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))</span> 
</pre></table></code></div></div><p>Here I set a display name, the container registry “Container Registry” which means Docker Hub, and select my previously created service connection “Docker Hub”. The command indicates that I want to push an image and I set the image name from the previously created variable. This task only runs when the previous task was successful and when the build is not triggered by a pull request.</p><h3 id="the-finished-azure-devops-ci-pipeline">The finished Azure DevOps CI Pipeline</h3><p>The finished pipeline looks as follows:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre><span class="na">name </span><span class="pi">:</span> <span class="s">Docker-CI</span>
<span class="na">trigger</span><span class="pi">:</span>
  <span class="na">branches</span><span class="pi">:</span>
    <span class="na">include</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">master</span>
 
<span class="na">pool</span><span class="pi">:</span>
  <span class="na">vmImage</span><span class="pi">:</span> <span class="s1">'</span><span class="s">ubuntu-latest'</span>
 
<span class="na">variables</span><span class="pi">:</span>
  <span class="na">ImageName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">wolfgangofner/microservicedemo:$(Build.BuildId)'</span>
 
<span class="na">stages</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s">Build</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">Build image</span>
  <span class="na">jobs</span><span class="pi">:</span>  
  <span class="pi">-</span> <span class="na">job</span><span class="pi">:</span> <span class="s">Build</span>
    <span class="na">displayName</span><span class="pi">:</span> <span class="s">Build and push Docker image</span>
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">Docker@1</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Build</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">Docker</span><span class="nv"> </span><span class="s">image'</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">containerregistrytype</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Container</span><span class="nv"> </span><span class="s">Registry'</span>
        <span class="na">dockerRegistryEndpoint</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Docker</span><span class="nv"> </span><span class="s">Hub'</span>
        <span class="na">command</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Build</span><span class="nv"> </span><span class="s">an</span><span class="nv"> </span><span class="s">image'</span>
        <span class="na">dockerFile</span><span class="pi">:</span> <span class="s1">'</span><span class="s">**/Dockerfile'</span>
        <span class="na">imageName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(ImageName)'</span>
        <span class="na">includeLatestTag</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">useDefaultContext</span><span class="pi">:</span> <span class="no">false</span>
        <span class="na">buildContext</span><span class="pi">:</span> <span class="s1">'</span><span class="s">.'</span>
     
    <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">Docker@1</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Push</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">Docker</span><span class="nv"> </span><span class="s">image</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">Dockerhub'</span>
      <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">containerregistrytype</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Container</span><span class="nv"> </span><span class="s">Registry'</span>
        <span class="na">dockerRegistryEndpoint</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Docker</span><span class="nv"> </span><span class="s">Hub'</span>
        <span class="na">command</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Push</span><span class="nv"> </span><span class="s">an</span><span class="nv"> </span><span class="s">image'</span>
        <span class="na">imageName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">$(ImageName)'</span>
      <span class="na">condition</span><span class="pi">:</span> <span class="s">and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))</span>
</pre></table></code></div></div><p>You can also find the code of the CI pipeline on <a href="https://github.com/WolfgangOfner/.NetCoreMicroserviceCiCdAks/blob/DockerCiPipeline/Docker-CI.yml" target="_blank" rel="noopener noreferrer">Github</a>.</p><h2 id="testing-the-azure-devops-ci-pipeline">Testing the Azure DevOps CI Pipeline</h2><p>Save the pipeline and run it. The build should succeed and a new image should be pushed to Docker Hub.</p><div id="attachment_2376" style="width: 710px" class="wp-caption aligncenter"> <a href="/assets/img/posts/2020/09/The-pipeline-ran-successfully.jpg"><img aria-describedby="caption-attachment-2376" loading="lazy" class="wp-image-2376" src="/assets/img/posts/2020/09/The-pipeline-ran-successfully.jpg" alt="The DevOps CI pipeline ran successfully" width="700" height="227" /></a><p id="caption-attachment-2376" class="wp-caption-text"> The pipeline ran successfully</p></div><p>The pipeline ran successfully and if I go to <a href="https://hub.docker.com/r/wolfgangofner/microservicedemo/tags" target="_blank" rel="noopener noreferrer">my repository on Docker Hub</a>, I should see a new image with the tag 232 there.</p><div id="attachment_2377" style="width: 710px" class="wp-caption aligncenter"> <a href="/assets/img/posts/2020/09/The-new-image-got-pushed-to-Docker-Hub.jpg"><img aria-describedby="caption-attachment-2377" loading="lazy" class="wp-image-2377" src="/assets/img/posts/2020/09/The-new-image-got-pushed-to-Docker-Hub.jpg" alt="The new image got pushed to Docker Hub" width="700" height="273" /></a><p id="caption-attachment-2377" class="wp-caption-text"> The new image got pushed to Docker Hub</p></div><h2 id="conclusion">Conclusion</h2><p>An automated CI pipeline to build and push new images is an integral point of every DevOps process. This post showed that it is quite simple to automate everything and create a new image every time changes are pushed to the master branch.</p><p>You can find the source code of this demo on <a href="https://github.com/WolfgangOfner/.NetCoreMicroserviceCiCdAks/tree/DockerCiPipeline" target="_blank" rel="noopener noreferrer">Github</a>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/devops/'>DevOps</a>, <a href='/categories/docker/'>Docker</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/azure-devops/" class="post-tag no-text-decoration" >Azure Devops</a> <a href="/tags/ci/" class="post-tag no-text-decoration" >CI</a> <a href="/tags/devops/" class="post-tag no-text-decoration" >DevOps</a> <a href="/tags/docker/" class="post-tag no-text-decoration" >docker</a> <a href="/tags/docker-hub/" class="post-tag no-text-decoration" >Docker Hub</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Create a Docker Image in an Azure DevOps CI Pipeline - Programming With Wolfgang&url=https://thankful-island-07643b903.azurestaticapps.net//create-a-docker-image-in-an-azure-devops-ci-pipeline/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Create a Docker Image in an Azure DevOps CI Pipeline - Programming With Wolfgang&u=https://thankful-island-07643b903.azurestaticapps.net//create-a-docker-image-in-an-azure-devops-ci-pipeline/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Create a Docker Image in an Azure DevOps CI Pipeline - Programming With Wolfgang&url=https://thankful-island-07643b903.azurestaticapps.net//create-a-docker-image-in-an-azure-devops-ci-pipeline/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://thankful-island-07643b903.azurestaticapps.net//create-a-docker-image-in-an-azure-devops-ci-pipeline/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><h3 data-toc-skip>Recent Update</h3><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/run-tests-inside-docker-during-ci/">Run Tests inside Docker during CI</a><li><a href="/repository-pattern-net-core/">Repository Pattern in .Net Core</a><li><a href="/proxy-pattern-in-net-core/">Proxy Pattern in .NET Core</a></ul></div><div id="access-tags"><h3 data-toc-skip>Trending Tags</h3><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/mediatr/">MediatR</a> <a class="post-tag" href="/tags/cqrs/">CQRS</a> <a class="post-tag" href="/tags/azure-devops/">Azure Devops</a> <a class="post-tag" href="/tags/docker-compose/">docker compose</a> <a class="post-tag" href="/tags/swagger/">Swagger</a> <a class="post-tag" href="/tags/scrum/">Scrum</a> <a class="post-tag" href="/tags/agile/">Agile</a> <a class="post-tag" href="/tags/xunit/">xUnit</a> <a class="post-tag" href="/tags/rabbitmq/">RabbitMQ</a> <a class="post-tag" href="/tags/mvc/">MVC</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><h3 data-toc-skip class="pl-3 pt-2 mb-2">Contents</h3><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/run-tests-inside-docker-during-ci/"><div class="card-body"> <span class="timeago small" > Sep 23 <i class="unloaded">2020-09-23T09:09:22+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Run Tests inside Docker during CI</h3><div class="text-muted small"><p> Running your build inside a Docker container has many advantages like platform independence and better testability for developers. These containers also bring more complexity though. In my last pos...</p></div></div></a></div><div class="card"> <a href="/create-net-core-in-ci-pipeline-in-azure-devops/"><div class="card-body"> <span class="timeago small" > Aug 3 <i class="unloaded">2020-08-03T19:24:06+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Create a .NET Core CI Pipeline in Azure DevOps</h3><div class="text-muted small"><p> A crucial feature of DevOps is to give the developer fast feedback if their code changes work. This can be done by automatically building code and running tests every time changes are checked-in. T...</p></div></div></a></div><div class="card"> <a href="/build-net-core-in-ci-pipeline-in-azure-devops/"><div class="card-body"> <span class="timeago small" > Oct 13 <i class="unloaded">2020-10-13T17:20:53+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Build .NET Core in a CI Pipeline in Azure DevOps</h3><div class="text-muted small"><p> A crucial feature of DevOps is to give the developer fast feedback if their code changes work. This can be done by automatically building code and running tests every time changes are checked-in. T...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/add-docker-to-a-asp-net-core-microservice/" class="btn btn-outline-primary"><p>Add Docker to an ASP .NET Core Microservice</p></a> <a href="/run-tests-inside-docker-during-ci/" class="btn btn-outline-primary"><p>Run Tests inside Docker during CI</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="font-italic text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> var options = { scriptUrl: '//programmingwithwolfgang.disqus.com/embed.js', disqusConfig: function () { this.page.url = 'https://thankful-island-07643b903.azurestaticapps.net//create-a-docker-image-in-an-azure-devops-ci-pipeline/'; this.page.identifier = '/create-a-docker-image-in-an-azure-devops-ci-pipeline/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2020 <a href="https://twitter.com/wolfgang_ofner">Wolfgang Ofner</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/mediatr/">MediatR</a> <a class="post-tag" href="/tags/cqrs/">CQRS</a> <a class="post-tag" href="/tags/azure-devops/">Azure Devops</a> <a class="post-tag" href="/tags/docker-compose/">docker compose</a> <a class="post-tag" href="/tags/swagger/">Swagger</a> <a class="post-tag" href="/tags/scrum/">Scrum</a> <a class="post-tag" href="/tags/agile/">Agile</a> <a class="post-tag" href="/tags/xunit/">xUnit</a> <a class="post-tag" href="/tags/rabbitmq/">RabbitMQ</a> <a class="post-tag" href="/tags/mvc/">MVC</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://thankful-island-07643b903.azurestaticapps.net/{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
