<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Programming a Microservice with .NET Core 3.1 | Programming With Wolfgang</title><meta name="generator" content="Jekyll v4.1.0" /><meta property="og:title" content="Programming a Microservice with .NET Core 3.1" /><meta name="author" content="Wolfgang Ofner" /><meta property="og:locale" content="en_US" /><meta name="description" content="In my last post, I talked about the theory of a microservice. Today it is going to be more practical. I will create two microservices using ASP .NET Core 3.1. Over the next posts., I will extend the microservices using CQRS, docker and docker-compose, RabbitMQ and automatic builds and deployments." /><meta property="og:description" content="In my last post, I talked about the theory of a microservice. Today it is going to be more practical. I will create two microservices using ASP .NET Core 3.1. Over the next posts., I will extend the microservices using CQRS, docker and docker-compose, RabbitMQ and automatic builds and deployments." /><link rel="canonical" href="http://0.0.0.0:4000/programming-microservices-net-core-3-1/" /><meta property="og:url" content="http://0.0.0.0:4000/programming-microservices-net-core-3-1/" /><meta property="og:site_name" content="Programming With Wolfgang" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-04-13T17:53:40+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Programming a Microservice with .NET Core 3.1" /><meta name="twitter:site" content="@wolfgang_ofner" /><meta name="twitter:creator" content="@Wolfgang Ofner" /><meta name="google-site-verification" content="xxsPm-h6A0B6a0QMgqXO80PU4DbMt4Dq06p-SGzB3TU" /> <script type="application/ld+json"> {"url":"http://0.0.0.0:4000/programming-microservices-net-core-3-1/","@type":"BlogPosting","headline":"Programming a Microservice with .NET Core 3.1","dateModified":"2020-04-13T17:53:40+02:00","datePublished":"2020-04-13T17:53:40+02:00","author":{"@type":"Person","name":"Wolfgang Ofner"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://0.0.0.0:4000/programming-microservices-net-core-3-1/"},"description":"In my last post, I talked about the theory of a microservice. Today it is going to be more practical. I will create two microservices using ASP .NET Core 3.1. Over the next posts., I will extend the microservices using CQRS, docker and docker-compose, RabbitMQ and automatic builds and deployments.","@context":"https://schema.org"}</script><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/jquery@3.4.1" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"> <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" async></script> <script src="/assets/js/post.min.js" async></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/author/wolfgang-small.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/">Programming With Wolfgang</a></div><div class="site-subtitle font-italic">Let's talk programming</div></div></div><div class="d-flex justify-content-center"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span></div><ul class="nav flex-column mt-3"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <i class="mode-toggle fas fa-sun" dark-mode-invisible></i> <i class="mode-toggle fas fa-moon" light-mode-invisible></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.mode != null) { if (this.mode == ModeToggle.DARK_MODE) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.mode != null) { if (self.mode == ModeToggle.DARK_MODE) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightkMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightkMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/wolfgangofner" target="_blank" > <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/wolfgang_ofner" target="_blank" > <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/wolfgangofner" target="_blank" > <i class="fab fa-linkedin"></i> </a> <a href=" javascript:window.open('mailto:' + ['wolfgang','programmingwithwolfgang.com'].join('@'))" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="d-sm-none row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Programming a Microservice with .NET Core 3.1</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><div style="visibility:hidden;"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel">Cancel</span></div></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Programming a Microservice with .NET Core 3.1</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Apr 13, 2020, 5:53 PM +0200" > Apr 13 <i class="unloaded">2020-04-13T17:53:40+02:00</i> </span> by <span class="author"> Wolfgang Ofner </span></div></div><div class="post-content"><p>In <a href="https://www.programmingwithwolfgang.com/microservices-getting-started/">my last post</a>, I talked about the theory of a microservice. Today it is going to be more practical. I will create two microservices using ASP .NET Core 3.1. Over the next posts., I will extend the microservices using CQRS, docker and docker-compose, RabbitMQ and automatic builds and deployments.</p><h2 id="create-a-microservice-using-asp-net-core-31">Create a Microservice using ASP .NET Core 3.1</h2><p>You can find the code of  the finished demo on <a href="https://github.com/WolfgangOfner/MicroserviceDemo" target="_blank" rel="noopener noreferrer">GitHub</a>. I will talk about the key aspects of the microservice but not about every detail. You will need at least a basic understanding of C# and ASP.NET Core.</p><h2 id="to-do-list-for-the-microservice">To-do list for the Microservice</h2><p>Our two microservice should satisfy the following requirements:</p><ul><li>Implement a Customer API with the following methods: create customer, update customer<li>Implement an Order API with the following methods: create order, pay order, get all orders which had already been paid<li>When a customer name is updated, it should also be updated in the Order API<li>The APIs should not directly call each other to update data<li>ASP .NET Core 3.1 Web API with DI/IoC<li>Communication between microservices should be implemented through some kind of queue<li>Use DDD and CQRS approaches with the Mediator and Repository Pattern</ul><p>To keep it simple, I will use an in-memory database. During the implementation, I will point out what you have to change if you want to use a normal database. I will split up the full implementation. In this post, I will create the microservices with the needed features. In the following posts, I will implement <a href="/document-your-microservice-with-swagger" target="_blank" rel="noopener noreferrer">Swagger</a>, create a <a href="/dockerize-an-asp-net-core-microservice-and-rabbitmq/" target="_blank" rel="noopener noreferrer">Docker container</a>, set up <a href="/rabbitmq-in-an-asp-net-core-3-1-microservice" target="_blank" rel="noopener noreferrer">RabbitMQ</a> and explain <a href="https://www.programmingwithwolfgang.com/cqrs-in-asp-net-core-3-1/">CQRS</a> and <a href="/mediator-pattern-in-asp-net-core-3-1/" target="_blank" rel="noopener noreferrer">Mediator</a>.</p><h2 id="structure-of-the-microservice">Structure of the Microservice</h2><p>I created a solution for each microservice. You can see the structure of the microservices on the following screenshot.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2020/04/Structure-of-the-Order-Microservice.jpg"><img loading="lazy" title="Structure of the Order Microservice" src="/assets/img/posts/2020/04/Structure-of-the-Order-Microservice.jpg" alt="Structure of the Order Microservice" /></a><p> Structure of the Order Microservice</p></div><p>Both microservice have exactly the same structure, except that the order solution has a Messaging.Receive project and the customer solution has a Messaging.Send project. I will use these projects later to send and receive data using RabbitMQ.</p><p>An important aspect of an API is that you don’t know who your consumers are and you should never break existing features. To implement versioning, I place everything like controllers or models in a v1 folder. If I want to extend my feature and it is not breaking the current behavior, I will extend it in the already existing classes. If my changes were to break the functionality, I will create a v2 folder and place the changes there. With this approach, no consumer is affected and they can implement the new features whenever they want or need them.</p><h2 id="the-api-project">The API Project</h2><p>The API project is the heart of the application and contains the controllers, validators, and models as well as the startup class in which all dependencies are registered.</p><h3 id="controllers-in-the-api-project">Controllers in the API Project</h3><p>I try to keep the controller methods as simple as possible. They only call different services and return a model or status to the client. They don’t do any business logic.</p><div class="language-csharp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="n">HttpPost</span><span class="p">]</span>
<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">ActionResult</span><span class="p">&lt;</span><span class="n">Customer</span><span class="p">&gt;&gt;</span> <span class="nf">Customer</span><span class="p">(</span><span class="n">CreateCustomerModel</span> <span class="n">createCustomerModel</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">_mediator</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="k">new</span> <span class="n">CreateCustomerCommand</span>
        <span class="p">{</span>
            <span class="n">Customer</span> <span class="p">=</span> <span class="n">_mapper</span><span class="p">.</span><span class="n">Map</span><span class="p">&lt;</span><span class="n">Customer</span><span class="p">&gt;(</span><span class="n">createCustomerModel</span><span class="p">)</span>
        <span class="p">});</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nf">BadRequest</span><span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span> 
</pre></table></code></div></div><p>The _mediator.Send is used to call a service using CQRS and the Mediator pattern. I will explain that in a later post. For now, it is important to understand that a service is called and that a Customer is returned. In case of an exception, a bad request and an error message are returned.</p><p>My naming convention is that I use the name of the object, in that case, Customer. The HTTP verb will tell you what this action does. In this case, the post will create an object, whereas put would update an existing customer.</p><h3 id="validators">Validators</h3><p>To validate the user input, I use the NuGet FluentValidations and a validator per model. Your validator inherits from AbstractValidator<T> where T is the class of the model you want to validate. Then you can add rules in the constructor of your validator. The validator is not really important for me right now and so I try to keep it simple and only validate that the first and last name has at least two characters and that the age and birthday are between zero and 150 years. I don&#8217;t validate if the birthday and the age match. This should be changed in the future.</T></p><div class="language-csharp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">CreateCustomerModelValidator</span> <span class="p">:</span> <span class="n">AbstractValidator</span><span class="p">&lt;</span><span class="n">CreateCustomerModel</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">CreateCustomerModelValidator</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nf">RuleFor</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">FirstName</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">NotNull</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">WithMessage</span><span class="p">(</span><span class="s">"The first name must be at least 2 character long"</span><span class="p">);</span>
        <span class="nf">RuleFor</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">FirstName</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">MinimumLength</span><span class="p">(</span><span class="m">2</span><span class="p">).</span>
            <span class="nf">WithMessage</span><span class="p">(</span><span class="s">"The first name must be at least 2 character long"</span><span class="p">);</span>
        
        <span class="nf">RuleFor</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">LastName</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">NotNull</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">WithMessage</span><span class="p">(</span><span class="s">"The last name must be at least 2 character long"</span><span class="p">);</span>
        <span class="nf">RuleFor</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">LastName</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">MinimumLength</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">WithMessage</span><span class="p">(</span><span class="s">"The last name must be at least 2 character long"</span><span class="p">);</span>

        <span class="nf">RuleFor</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Birthday</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">InclusiveBetween</span><span class="p">(</span><span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="nf">AddYears</span><span class="p">(-</span><span class="m">150</span><span class="p">).</span><span class="n">Date</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">WithMessage</span><span class="p">(</span><span class="s">"The birthday must not be longer ago than 150 years and can not be in the future"</span><span class="p">);</span>
            
        <span class="nf">RuleFor</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Age</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">InclusiveBetween</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">150</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">WithMessage</span><span class="p">(</span><span class="s">"The minimum age is 0 and the maximum age is 150 years"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>  
</pre></table></code></div></div><h3 id="startup">Startup</h3><p>In the Startup.cs, I register my services, validators and configure other parts of the application like AutoMapper, the database context or Swagger. This part should be self-explanatory and I will talk about <a href="/document-your-microservice-with-swagger" target="_blank" rel="noopener noreferrer">Swagger</a> or <a href="/rabbitmq-in-an-asp-net-core-3-1-microservice" target="_blank" rel="noopener noreferrer">RabbitMQ</a> later.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2020/04/Register-the-classes-and-configure-the-services.jpg"><img loading="lazy" src="/assets/img/posts/2020/04/Register-the-classes-and-configure-the-services.jpg" alt="Register the classes and configure the services" /></a><p> Register the classes and configure the services</p></div><h2 id="data">Data</h2><p>The Data project contains everything needed to access the database. I use Entity Framework Core, an in-memory database and the repository pattern.</p><h3 id="database-context">Database Context</h3><p>In the database context, I add a list of customers that I will use to update an existing customer. The database context is created for every request, therefore updated or created customers will be lost after the request. This behavior is fine for the sake of this demo.</p><div class="language-csharp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="nf">CustomerContext</span><span class="p">(</span><span class="n">DbContextOptions</span><span class="p">&lt;</span><span class="n">CustomerContext</span><span class="p">&gt;</span> <span class="n">options</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">customers</span> <span class="p">=</span> <span class="k">new</span><span class="p">[]</span>
    <span class="p">{</span>
        <span class="k">new</span> <span class="n">Customer</span>
        <span class="p">{</span>
            <span class="n">Id</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="s">"9f35b48d-cb87-4783-bfdb-21e36012930a"</span><span class="p">),</span>
            <span class="n">FirstName</span> <span class="p">=</span> <span class="s">"Wolfgang"</span><span class="p">,</span>
            <span class="n">LastName</span> <span class="p">=</span> <span class="s">"Ofner"</span><span class="p">,</span>
            <span class="n">Birthday</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DateTime</span><span class="p">(</span><span class="m">1989</span><span class="p">,</span> <span class="m">11</span><span class="p">,</span> <span class="m">23</span><span class="p">),</span>
            <span class="n">Age</span> <span class="p">=</span> <span class="m">30</span>
        <span class="p">},</span>
        <span class="k">new</span> <span class="n">Customer</span>
        <span class="p">{</span>
            <span class="n">Id</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="s">"654b7573-9501-436a-ad36-94c5696ac28f"</span><span class="p">),</span>
            <span class="n">FirstName</span> <span class="p">=</span> <span class="s">"Darth"</span><span class="p">,</span>
            <span class="n">LastName</span> <span class="p">=</span> <span class="s">"Vader"</span><span class="p">,</span>
            <span class="n">Birthday</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DateTime</span><span class="p">(</span><span class="m">1977</span><span class="p">,</span> <span class="m">05</span><span class="p">,</span> <span class="m">25</span><span class="p">),</span>
            <span class="n">Age</span> <span class="p">=</span> <span class="m">43</span>
        <span class="p">},</span>
        <span class="k">new</span> <span class="n">Customer</span>
        <span class="p">{</span>
            <span class="n">Id</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="s">"971316e1-4966-4426-b1ea-a36c9dde1066"</span><span class="p">),</span>
            <span class="n">FirstName</span> <span class="p">=</span> <span class="s">"Son"</span><span class="p">,</span>
            <span class="n">LastName</span> <span class="p">=</span> <span class="s">"Goku"</span><span class="p">,</span>
            <span class="n">Birthday</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DateTime</span><span class="p">(</span><span class="m">1937</span><span class="p">,</span> <span class="m">04</span><span class="p">,</span> <span class="m">16</span><span class="p">),</span>
            <span class="n">Age</span> <span class="p">=</span> <span class="m">83</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="n">Customer</span><span class="p">.</span><span class="nf">AddRange</span><span class="p">(</span><span class="n">customers</span><span class="p">);</span>
    <span class="nf">SaveChanges</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">public</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">Customer</span><span class="p">&gt;</span> <span class="n">Customer</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> 
</pre></table></code></div></div><p>If you want to use a normal database, all you have to do is delete the adding of customers in the constructor and change the following line in the Startup class to take your connection string instead of using an in-memory database.</p><div class="language-csharp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">services</span><span class="p">.</span><span class="n">AddDbContext</span><span class="p">&lt;</span><span class="n">CustomerContext</span><span class="p">&gt;(</span><span class="n">options</span> <span class="p">=&gt;</span> <span class="n">options</span><span class="p">.</span><span class="nf">UseInMemoryDatabase</span><span class="p">(</span><span class="n">Guid</span><span class="p">.</span><span class="nf">NewGuid</span><span class="p">().</span><span class="nf">ToString</span><span class="p">()));</span>  
</pre></table></code></div></div><p>You can either hard-code your connection string in the Startup class or better, read it from the appsettings.json file.</p><div class="language-csharp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">services</span><span class="p">.</span><span class="n">AddDbContext</span><span class="p">&lt;</span><span class="n">CustomerContext</span><span class="p">&gt;(</span><span class="n">options</span> <span class="p">=&gt;</span> <span class="n">options</span><span class="p">.</span><span class="nf">UseSqlServer</span><span class="p">(</span><span class="n">Configuration</span><span class="p">[</span><span class="s">"Database:ConnectionString"</span><span class="p">]));</span>  
</pre></table></code></div></div><h3 id="repository">Repository</h3><p>I have a generic repository for CRUD operations which can be used for every entity. This repository has methods like AddAsync and UpdateAsync.</p><div class="language-csharp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">Repository</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IRepository</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;</span> <span class="k">where</span> <span class="n">TEntity</span> <span class="p">:</span> <span class="k">class</span><span class="err">,</span> <span class="nc">new</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">readonly</span> <span class="n">CustomerContext</span> <span class="n">CustomerContext</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">Repository</span><span class="p">(</span><span class="n">CustomerContext</span> <span class="n">customerContext</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">CustomerContext</span> <span class="p">=</span> <span class="n">customerContext</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;</span> <span class="nf">GetAll</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">try</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">CustomerContext</span><span class="p">.</span><span class="n">Set</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;();</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">$"Couldn't retrieve entities: </span><span class="p">{</span><span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;</span> <span class="nf">AddAsync</span><span class="p">(</span><span class="n">TEntity</span> <span class="n">entity</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">entity</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">AddAsync</span><span class="p">)}</span><span class="s"> entity must not be null"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">try</span>
        <span class="p">{</span>
            <span class="k">await</span> <span class="n">CustomerContext</span><span class="p">.</span><span class="nf">AddAsync</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>
            <span class="k">await</span> <span class="n">CustomerContext</span><span class="p">.</span><span class="nf">SaveChangesAsync</span><span class="p">();</span>

            <span class="k">return</span> <span class="n">entity</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">entity</span><span class="p">)}</span><span class="s"> could not be saved: </span><span class="p">{</span><span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;</span> <span class="nf">UpdateAsync</span><span class="p">(</span><span class="n">TEntity</span> <span class="n">entity</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">entity</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">AddAsync</span><span class="p">)}</span><span class="s"> entity must not be null"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">try</span>
        <span class="p">{</span>
            <span class="n">CustomerContext</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>
            <span class="k">await</span> <span class="n">CustomerContext</span><span class="p">.</span><span class="nf">SaveChangesAsync</span><span class="p">();</span>

            <span class="k">return</span> <span class="n">entity</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">entity</span><span class="p">)}</span><span class="s"> could not be updated </span><span class="p">{</span><span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span> 
</pre></table></code></div></div><p>Additionally to the generic repository, I have a CustomerRepository that implements a Customer specific method, GetCustomerByIdAsync.</p><div class="language-csharp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">CustomerRepository</span> <span class="p">:</span> <span class="n">Repository</span><span class="p">&lt;</span><span class="n">Customer</span><span class="p">&gt;,</span> <span class="n">ICustomerRepository</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">CustomerRepository</span><span class="p">(</span><span class="n">CustomerContext</span> <span class="n">customerContext</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">customerContext</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Customer</span><span class="p">&gt;</span> <span class="nf">GetCustomerByIdAsync</span><span class="p">(</span><span class="n">Guid</span> <span class="n">id</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">CustomerContext</span><span class="p">.</span><span class="n">Customer</span><span class="p">.</span><span class="nf">FirstOrDefaultAsync</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">id</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span> 
</pre></table></code></div></div><p>The OrderRepository has more Order specific methods. The CustomerRepository inherits from the generic repository and its interface inherits from the repository interface. Since the CustomerContext has the protected access modified in the generic repository, I can reuse it in my CustomerRepository.</p><h2 id="domain">Domain</h2><p>The Domain project contains all entities and no business logic. In my microservice, this is only the Customer or Order entity.</p><h2 id="messagingsend">Messaging.Send</h2><p>The Messaging.Send project contains everything I need to send Customer objects to a RabbitMQ queue. I will talk about the specifics of the implementation in a later post.</p><div class="language-csharp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">void</span> <span class="nf">SendCustomer</span><span class="p">(</span><span class="n">Customer</span> <span class="n">customer</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">factory</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ConnectionFactory</span><span class="p">()</span> <span class="p">{</span> <span class="n">HostName</span> <span class="p">=</span> <span class="n">_hostname</span><span class="p">,</span> <span class="n">UserName</span> <span class="p">=</span> <span class="n">_username</span><span class="p">,</span> <span class="n">Password</span> <span class="p">=</span> <span class="n">_password</span> <span class="p">};</span>
    
    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">connection</span> <span class="p">=</span> <span class="n">factory</span><span class="p">.</span><span class="nf">CreateConnection</span><span class="p">())</span>
    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">channel</span> <span class="p">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">CreateModel</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="n">channel</span><span class="p">.</span><span class="nf">QueueDeclare</span><span class="p">(</span><span class="n">queue</span><span class="p">:</span> <span class="n">_queueName</span><span class="p">,</span> <span class="n">durable</span><span class="p">:</span> <span class="k">false</span><span class="p">,</span> <span class="n">exclusive</span><span class="p">:</span> <span class="k">false</span><span class="p">,</span> <span class="n">autoDelete</span><span class="p">:</span> <span class="k">false</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="k">null</span><span class="p">);</span>

        <span class="kt">var</span> <span class="n">json</span> <span class="p">=</span> <span class="n">JsonConvert</span><span class="p">.</span><span class="nf">SerializeObject</span><span class="p">(</span><span class="n">customer</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">body</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">json</span><span class="p">);</span>

        <span class="n">channel</span><span class="p">.</span><span class="nf">BasicPublish</span><span class="p">(</span><span class="n">exchange</span><span class="p">:</span> <span class="s">""</span><span class="p">,</span> <span class="n">routingKey</span><span class="p">:</span> <span class="n">_queueName</span><span class="p">,</span> <span class="n">basicProperties</span><span class="p">:</span> <span class="k">null</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="n">body</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>  
</pre></table></code></div></div><h2 id="service">Service</h2><p>The Service project is split into Command and Query. This is how CQRS separates the concerns of reading and writing data. I will go into the details in a later post. For now, all you have to know is that commands write data and queries read data. A query consists of a query and a handler. The query indicates what action should be executed and the handler implements this action. The command works with the same principle.</p><div class="language-csharp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">CreateCustomerCommandHandler</span> <span class="p">:</span> <span class="n">IRequestHandler</span><span class="p">&lt;</span><span class="n">CreateCustomerCommand</span><span class="p">,</span> <span class="n">Customer</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">ICustomerRepository</span> <span class="n">_customerRepository</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">CreateCustomerCommandHandler</span><span class="p">(</span><span class="n">ICustomerRepository</span> <span class="n">customerRepository</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_customerRepository</span> <span class="p">=</span> <span class="n">customerRepository</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Customer</span><span class="p">&gt;</span> <span class="nf">Handle</span><span class="p">(</span><span class="n">CreateCustomerCommand</span> <span class="n">request</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">_customerRepository</span><span class="p">.</span><span class="nf">AddAsync</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">Customer</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>  
</pre></table></code></div></div><p>The handler often calls the repository to retrieve or change data.</p><h2 id="tests">Tests</h2><p>For my tests, I like to create a test project for each normal project wheres the name is the same except that I add .Test at the end. I use xUnit, FakeItEasy, and FluentAssertions. Currently, there are no tests for the RabbitMQ logic.</p><h2 id="run-the-microservice">Run the Microservice</h2><p>In the previous section I only talked about the Customer service but the Order service has the same structure and should be easy to understand.</p><p>Now that the base functionality is set up, it is time to test both microservice. Before you can start them, you have to make two small changes to be actually able to start them. Currently, we have no queue and therefore the microservices will generate an exception. In the future, it would be nice if the microservices could work even without a queue.</p><h2 id="edit-the-customer-service">Edit the Customer Service</h2><p>Open the CustomerCommandHandler in the Service project and comment out the following line _customerUpdateSender.SendCustomer(customer);</p><div class="language-csharp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Customer</span><span class="p">&gt;</span> <span class="nf">Handle</span><span class="p">(</span><span class="n">UpdateCustomerCommand</span> <span class="n">request</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">customer</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_customerRepository</span><span class="p">.</span><span class="nf">UpdateAsync</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">Customer</span><span class="p">);</span>

    <span class="c1">// _customerUpdateSender.SendCustomer(customer);</span>

    <span class="k">return</span> <span class="n">customer</span><span class="p">;</span>
<span class="p">}</span>  
</pre></table></code></div></div><p>This line is responsible for publishing the Customer to the queue</p><h2 id="edit-the-order-service">Edit the Order Service</h2><p>In the Order API, you have to comment out services.AddHostedService<CustomerFullNameUpdateReceiver>(); in the Startup class of the API project.</CustomerFullNameUpdateReceiver></p><div class="language-csharp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="n">services</span><span class="p">.</span><span class="n">AddTransient</span><span class="p">&lt;</span><span class="n">IRequestHandler</span><span class="p">&lt;</span><span class="n">GetPaidOrderQuery</span><span class="p">,</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Order</span><span class="p">&gt;&gt;,</span> <span class="n">GetPaidOrderQueryHandler</span><span class="p">&gt;();</span>  
<span class="n">services</span><span class="p">.</span><span class="n">AddTransient</span><span class="p">&lt;</span><span class="n">IRequestHandler</span><span class="p">&lt;</span><span class="n">GetOrderByIdQuery</span><span class="p">,</span> <span class="n">Order</span><span class="p">&gt;,</span> <span class="n">GetOrderByIdQueryHandler</span><span class="p">&gt;();</span>  
<span class="n">services</span><span class="p">.</span><span class="n">AddTransient</span><span class="p">&lt;</span><span class="n">IRequestHandler</span><span class="p">&lt;</span><span class="n">GetOrderByCustomerGuidQuery</span><span class="p">,</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Order</span><span class="p">&gt;&gt;,</span> <span class="n">GetOrderByCustomerGuidQueryHandler</span><span class="p">&gt;();</span>  
<span class="n">services</span><span class="p">.</span><span class="n">AddTransient</span><span class="p">&lt;</span><span class="n">IRequestHandler</span><span class="p">&lt;</span><span class="n">CreateOrderCommand</span><span class="p">,</span> <span class="n">Order</span><span class="p">&gt;,</span> <span class="n">CreateOrderCommandHandler</span><span class="p">&gt;();</span>  
<span class="n">services</span><span class="p">.</span><span class="n">AddTransient</span><span class="p">&lt;</span><span class="n">IRequestHandler</span><span class="p">&lt;</span><span class="n">PayOrderCommand</span><span class="p">,</span> <span class="n">Order</span><span class="p">&gt;,</span> <span class="n">PayOrderCommandHandler</span><span class="p">&gt;();</span>  
<span class="n">services</span><span class="p">.</span><span class="n">AddTransient</span><span class="p">&lt;</span><span class="n">IRequestHandler</span><span class="p">&lt;</span><span class="n">UpdateOrderCommand</span><span class="p">&gt;,</span> <span class="n">UpdateOrderCommandHandler</span><span class="p">&gt;();</span>  
<span class="n">services</span><span class="p">.</span><span class="n">AddTransient</span><span class="p">&lt;</span><span class="n">ICustomerNameUpdateService</span><span class="p">,</span> <span class="n">CustomerNameUpdateService</span><span class="p">&gt;();</span>

<span class="c1">// services.AddHostedService&lt;CustomerFullNameUpdateReceiver&gt;();  </span>
</pre></table></code></div></div><p>This line would register a background service that listens to change in the queue and would pull these changes.</p><h2 id="test-the-microservice">Test the Microservice</h2><p>After you made the changes to both APIs, you can start them. This should display the Swagger GUI which gives you information about all actions and models and also lets you send requests. The GUI should be self-explanatory but <a href="/document-your-microservice-with-swagger" target="_blank" rel="noopener noreferrer">I will talk more about it in my next post</a>.</p><div class="col-12 col-sm-10 aligncenter"> <a href="/assets/img/posts/2020/04/The-Swagger-GUI-with-the-available-actions-and-models.jpg"><img loading="lazy" src="/assets/img/posts/2020/04/The-Swagger-GUI-with-the-available-actions-and-models.jpg" alt="The Swagger GUI with the available actions and models" /></a><p> The Swagger GUI with the available actions and models</p></div><h2 id="conclusion">Conclusion</h2><p>Today, I talked about the structure and the features of my microservices. This is just the beginning but both applications are working and could be already deployed. It is important to keep in mind that each microservice has its own data storage and is kept as simple as possible.</p><p><a href="/document-your-microservice-with-swagger" target="_blank" rel="noopener noreferrer">In my next post, I will talk about Swagger</a> and how you can use it to easily and quickly document your microservice while providing the opportunity to test requests.</p><p>Note: On October 11, I removed the Solution folder and moved the projects to the root level. Over the last months I made the experience that this makes it quite simpler to work with Dockerfiles and have automated builds and deployments.</p><p>You can find the code of  the finished demo on <a href="https://github.com/WolfgangOfner/MicroserviceDemo" target="_blank" rel="noopener noreferrer">GitHub</a>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/asp.net/'>ASP.NET</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/net-core-3.1/" class="post-tag no-text-decoration">NET Core 3.1</a> <a href="/tags/c%23/" class="post-tag no-text-decoration">C#</a> <a href="/tags/cqrs/" class="post-tag no-text-decoration">CQRS</a> <a href="/tags/docker/" class="post-tag no-text-decoration">docker</a> <a href="/tags/docker-compose/" class="post-tag no-text-decoration">docker-compose</a> <a href="/tags/mediatr/" class="post-tag no-text-decoration">MediatR</a> <a href="/tags/microservice/" class="post-tag no-text-decoration">microservice</a> <a href="/tags/rabbitmq/" class="post-tag no-text-decoration">RabbitMQ</a> <a href="/tags/swagger/" class="post-tag no-text-decoration">Swagger</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Programming a Microservice with .NET Core 3.1 - Programming With Wolfgang&url=http://0.0.0.0:4000/programming-microservices-net-core-3-1/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Programming a Microservice with .NET Core 3.1 - Programming With Wolfgang&u=http://0.0.0.0:4000/programming-microservices-net-core-3-1/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Programming a Microservice with .NET Core 3.1 - Programming With Wolfgang&url=http://0.0.0.0:4000/programming-microservices-net-core-3-1/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=http://0.0.0.0:4000/programming-microservices-net-core-3-1/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><h3 data-toc-skip>Recent Update</h3><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/how-i-learned-programming-part-3/">How I learned programming - Part 3</a><li><a href="/bot-third-party-integration/">Integrate your Bot in Third-Party Applications</a></ul></div><div id="access-tags"><h3 data-toc-skip>Trending Tags</h3><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/xunit/">xUnit</a> <a class="post-tag" href="/tags/mediatr/">MediatR</a> <a class="post-tag" href="/tags/cqrs/">CQRS</a> <a class="post-tag" href="/tags/docker-compose/">docker compose</a> <a class="post-tag" href="/tags/swagger/">Swagger</a> <a class="post-tag" href="/tags/scrum/">Scrum</a> <a class="post-tag" href="/tags/ci/">CI</a> <a class="post-tag" href="/tags/agile/">Agile</a> <a class="post-tag" href="/tags/rabbitmq/">RabbitMQ</a> <a class="post-tag" href="/tags/mvc/">MVC</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><h3 data-toc-skip class="pl-3 pt-2 mb-2">Contents</h3><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/set-up-docker-compose-for-asp-net-core-3-1-microservices/"><div class="card-body"> <span class="timeago small" > Apr 24 <i class="unloaded">2020-04-24T11:04:16+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Set up Docker-Compose for ASP .NET Core 3.1 Microservices</h3><div class="text-muted small"><p> In my last post, I described how to dockerize my microservices. To start the whole application, you have to start both microservices and RabbitMq. Today, I will add a docker-compose file which is a...</p></div></div></a></div><div class="card"> <a href="/document-your-microservice-with-swagger/"><div class="card-body"> <span class="timeago small" > Apr 15 <i class="unloaded">2020-04-15T17:37:49+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Document your Microservice with Swagger</h3><div class="text-muted small"><p> Swagger is an open-source toolset that can be easily integrated into your solution and which helps you to document and test your APIs. It is so simple that even none technical people can use it. In...</p></div></div></a></div><div class="card"> <a href="/mediator-pattern-in-asp-net-core-3-1/"><div class="card-body"> <span class="timeago small" > Apr 17 <i class="unloaded">2020-04-17T14:05:38+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Mediator Pattern in ASP .NET Core 3.1</h3><div class="text-muted small"><p> The mediator pattern is a behavioral design pattern that helps to reduce chaotic dependencies between objects. The main goal is to disallow direct communication between the objects and instead forc...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/microservices-getting-started/" class="btn btn-outline-primary"><p>Microservices - Getting Started</p></a> <a href="/document-your-microservice-with-swagger/" class="btn btn-outline-primary"><p>Document your Microservice with Swagger</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="font-italic text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> var options = { scriptUrl: '//programmingwithwolfgang.disqus.com/embed.js', disqusConfig: function () { this.page.url = 'http://0.0.0.0:4000/programming-microservices-net-core-3-1/'; this.page.identifier = '/programming-microservices-net-core-3-1/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2020 <a href="https://twitter.com/wolfgang_ofner">Wolfgang Ofner</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/xunit/">xUnit</a> <a class="post-tag" href="/tags/mediatr/">MediatR</a> <a class="post-tag" href="/tags/cqrs/">CQRS</a> <a class="post-tag" href="/tags/docker-compose/">docker compose</a> <a class="post-tag" href="/tags/swagger/">Swagger</a> <a class="post-tag" href="/tags/scrum/">Scrum</a> <a class="post-tag" href="/tags/ci/">CI</a> <a class="post-tag" href="/tags/agile/">Agile</a> <a class="post-tag" href="/tags/rabbitmq/">RabbitMQ</a> <a class="post-tag" href="/tags/mvc/">MVC</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="http://0.0.0.0:4000{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
